"use strict";
/**
 * Created by user on 2018/1/27/027.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const mdconf = require("mdconf2");
exports.mdconf = mdconf;
const crlf_normalize_1 = require("crlf-normalize");
exports.crlf = crlf_normalize_1.crlf;
exports.LF = crlf_normalize_1.LF;
const lib_1 = require("./lib");
exports.array_unique = lib_1.array_unique;
exports.deepmerge = lib_1.deepmerge;
exports.deepmergeOptions = lib_1.deepmergeOptions;
const isPlainObject = require("is-plain-object");
const sortObjectKeys = require("sort-object-keys2");
const json_1 = require("./json");
const env_bool_1 = require("env-bool");
exports.envVal = env_bool_1.envVal;
exports.envBool = env_bool_1.envBool;
const hex_lib_1 = require("hex-lib");
const chai_1 = require("chai");
exports.defaultOptionsParse = {
    removeRawData: true,
    disableKeyToLowerCase: true,
};
function stringify(data, d2, ...argv) {
    data = _handleDataForStringify(data, d2, ...argv);
    return mdconf.stringify(data) + crlf_normalize_1.LF.repeat(2);
}
exports.stringify = stringify;
function parse(data, options = {}) {
    if (options.removeRawData) {
        options.oldParseApi = options.removeRawData;
    }
    if (options.disableKeyToLowerCase == null) {
        options.disableKeyToLowerCase = true;
    }
    let ret = mdconf.parse(crlf_normalize_1.crlf(data.toString()), options);
    try {
        if (ret.novel && ret.novel.preface) {
            ret.novel.preface = (ret.novel.preface
                && ret.novel.preface.length
                && Array.isArray(ret.novel.preface)) ? ret.novel.preface.join(crlf_normalize_1.LF) : ret.novel.preface;
        }
        if (!options.lowCheckLevel || ret.options) {
            ret.options = lib_1.deepmerge(ret.options || {}, {
                textlayout: {},
            }, lib_1.deepmergeOptions);
        }
    }
    catch (e) {
        console.error(e.toString());
    }
    if (options.chk || options.chk == null) {
        ret = chkInfo(ret, options);
    }
    if (options.throw || options.throw == null) {
        ret = chkInfo(ret, options);
        if (!ret) {
            throw new Error('mdconf_parse');
        }
    }
    if (ret) {
        ret = sortKeys(ret);
        //console.log(777);
    }
    // @ts-ignore
    return ret;
}
exports.parse = parse;
function _handleData(data, d2, ...argv) {
    // @ts-ignore
    data = json_1.default.toNovelInfo(data, d2 || {}, {
        novel: {
            tags: [],
        },
    }, ...argv);
    data = sortKeys(data);
    data.novel.tags.unshift('node-novel');
    data.novel.tags = lib_1.array_unique(data.novel.tags);
    // @ts-ignore
    return data;
}
exports._handleData = _handleData;
function _handleDataForStringify(data, d2, ...argv) {
    data = _handleData(data, d2, ...argv);
    if (data.novel.preface && typeof data.novel.preface == 'string') {
        data.novel.preface = new mdconf.RawObject(data.novel.preface, {});
    }
    if ('novel_status' in data.novel) {
        chai_1.expect(data.novel.novel_status).a('number');
        data.novel.novel_status = hex_lib_1.toHex(data.novel.novel_status, 4);
    }
    // @ts-ignore
    return data;
}
exports._handleDataForStringify = _handleDataForStringify;
function sortKeys(ret) {
    // @ts-ignore
    ret = sortObjectKeys(ret, [
        'novel',
        'contribute',
        'options',
    ]);
    sortSubKey('novel', [
        'title',
        'title_short',
        'title_zh',
        'title_zh1',
        'title_zh2',
        'title_en',
        'title_jp',
        'title_output',
        'title_other',
        'title_source',
        'author',
        'authors',
        'illust',
        'illusts',
        'source',
        'cover',
        'publisher',
        'publishers',
        'date',
        'status',
        'novel_status',
        'r18',
        'series',
        'preface',
        'tags',
    ]);
    sortSubKey(['novel', 'tags'], null, true);
    sortSubKey('contribute', null, true);
    sortSubKey('options');
    function sortSubKey(key, sortList, unique) {
        let obj = ret;
        let parent = obj;
        //console.log(obj, sortList);
        if (Array.isArray(key)) {
            //console.log(key);
            let _k;
            for (let value of key) {
                if (!(value in obj)) {
                    //console.log(value, parent);
                    return;
                }
                _k = value;
                parent = obj;
                obj = parent[value];
            }
            key = _k;
        }
        else if ((key in parent)) {
            obj = parent[key];
        }
        else {
            return;
        }
        if (Array.isArray(obj)) {
            obj.sort();
            parent[key] = obj;
            if (unique) {
                parent[key] = parent[key].filter(function (v) {
                    return v;
                });
                parent[key] = lib_1.array_unique(parent[key]);
                if (parent[key].length == 1 && (parent[key][0] === null || typeof parent[key][0] == 'undefined')) {
                    parent[key] = [];
                }
            }
            return;
        }
        if (isPlainObject(obj)) {
            parent[key] = sortObjectKeys(obj, sortList);
        }
    }
    // @ts-ignore
    return ret;
}
exports.sortKeys = sortKeys;
function chkInfo(ret, options = {}) {
    if (!ret
        || ((!options || !options.lowCheckLevel)
            && (!ret.novel || !ret.novel.title))) {
        return null;
    }
    if (ret.novel) {
        [
            'authors',
            'illusts',
            'tags',
            'sources',
            'publishers',
        ].forEach(k => {
            if (k in ret.novel) {
                ret.novel[k] = anyToArray(ret.novel[k], true);
            }
        });
        if ('novel_status' in ret.novel) {
            ret.novel.novel_status = env_bool_1.envVal(ret.novel.novel_status);
            if (typeof ret.novel.novel_status === 'string' && /^0x[\da-f]+$/.test(ret.novel.novel_status)) {
                ret.novel.novel_status = Number(ret.novel.novel_status);
            }
        }
    }
    if ('contribute' in ret) {
        ret.contribute = anyToArray(ret.contribute, true);
    }
    if (!options.lowCheckLevel) {
        ret.options = ret.options || {};
    }
    if (ret.options) {
        if (typeof ret.options.textlayout === 'object') {
            Object.entries(ret.options.textlayout)
                .forEach(([k, v]) => ret.options.textlayout[k] = env_bool_1.envVal(v));
        }
        if (typeof ret.options.downloadOptions === 'object') {
            Object.entries(ret.options.downloadOptions)
                .forEach(([k, v]) => ret.options.downloadOptions[k] = env_bool_1.envVal(v));
        }
    }
    return ret;
}
exports.chkInfo = chkInfo;
function getNovelTitleFromMeta(meta) {
    if (meta && meta.novel) {
        let arr = [
            'title',
            'title_source',
            'title_jp',
            'title_ja',
            'title_zh',
            'title_tw',
            'title_cn',
        ].concat(lib_1.filterByPrefixReturnKeys('title_', meta.novel))
            .reduce(function (a, key) {
            if (key in meta.novel) {
                a.push(meta.novel[key]);
            }
            return a;
        }, []);
        if (meta.novel.series) {
            arr.push(meta.novel.series.name);
            arr.push(meta.novel.series.name_short);
        }
        arr = lib_1.array_unique(arr.filter(v => v && ![
            'undefined',
            '長編 【連載】',
            '連載中',
        ].includes(v)));
        return arr;
    }
    return [];
}
exports.getNovelTitleFromMeta = getNovelTitleFromMeta;
function anyToArray(input, unique) {
    if (typeof input != 'object') {
        input = [input];
    }
    if (unique) {
        input = lib_1.array_unique(input || []);
    }
    // @ts-ignore
    return input;
}
exports.version = require("./package.json").version;
exports.mdconf_parse = parse;
exports.default = exports;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBR0gsa0NBQW1DO0FBVzFCLHdCQUFNO0FBVmYsbURBQTBDO0FBVVgsZUFWdEIscUJBQUksQ0FVc0I7QUFBRSxhQVZ0QixtQkFBRSxDQVVzQjtBQVR2QywrQkFBNEY7QUFTM0UsdUJBVFIsa0JBQVksQ0FTUTtBQUNwQixvQkFWYyxlQUFTLENBVWQ7QUFBRSwyQkFWYyxzQkFBZ0IsQ0FVZDtBQVJwQyxpREFBa0Q7QUFDbEQsb0RBQXFEO0FBQ3JELGlDQUE0QjtBQUM1Qix1Q0FBMkM7QUFNbEMsaUJBTkEsaUJBQU0sQ0FNQTtBQUFFLGtCQU5BLGtCQUFPLENBTUE7QUFMeEIscUNBQWdDO0FBQ2hDLCtCQUE4QjtBQThLakIsUUFBQSxtQkFBbUIsR0FBa0I7SUFDakQsYUFBYSxFQUFFLElBQUk7SUFDbkIscUJBQXFCLEVBQUUsSUFBSTtDQUMzQixDQUFDO0FBRUYsU0FBZ0IsU0FBUyxDQUFDLElBQUksRUFBRSxFQUFHLEVBQUUsR0FBRyxJQUFJO0lBRTNDLElBQUksR0FBRyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFFbEQsT0FBTyxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLG1CQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzlDLENBQUM7QUFMRCw4QkFLQztBQU1ELFNBQWdCLEtBQUssQ0FBd0IsSUFBSSxFQUFFLFVBQXlCLEVBQUU7SUFFN0UsSUFBSSxPQUFPLENBQUMsYUFBYSxFQUN6QjtRQUNDLE9BQU8sQ0FBQyxXQUFXLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQztLQUM1QztJQUVELElBQUksT0FBTyxDQUFDLHFCQUFxQixJQUFJLElBQUksRUFDekM7UUFDQyxPQUFPLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFD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a0JBQVksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDeEMsV0FBVztZQUNYLFNBQVM7WUFDVCxLQUFLO1NBQ0wsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRWhCLE9BQU8sR0FBRyxDQUFDO0tBQ1g7SUFFRCxPQUFPLEVBQUUsQ0FBQztBQUNYLENBQUM7QUF4Q0Qsc0RBd0NDO0FBRUQsU0FBUyxVQUFVLENBQWEsS0FBYyxFQUFFLE1BQWdCO0lBRS9ELElBQUksT0FBTyxLQUFLLElBQUksUUFBUSxFQUM1QjtRQUNDLEtBQUssR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ2hCO0lBRUQsSUFBSSxNQUFNLEVBQ1Y7UUFDQyxLQUFLLEdBQUcsa0JBQVksQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLENBQUM7S0FDbEM7SUFFRCxhQUFhO0lBQ2IsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDO0FBRVksUUFBQSxPQUFPLEdBQVcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUMsT0FBTyxDQUFDO0FBRXBELFFBQUEsWUFBWSxHQUFHLEtBQUssQ0FBQztBQUVsQyxrQkFBZSxPQUFtQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjAxOC8xLzI3LzAyNy5cbiAqL1xuXG5pbXBvcnQgeyBFbnVtTm92ZWxTdGF0dXMgfSBmcm9tICcuL2xpYi9jb25zdCc7XG5pbXBvcnQgbWRjb25mID0gcmVxdWlyZSgnbWRjb25mMicpO1xuaW1wb3J0IHsgY3JsZiwgTEYgfSBmcm9tICdjcmxmLW5vcm1hbGl6ZSc7XG5pbXBvcnQgeyBhcnJheV91bmlxdWUsIGRlZXBtZXJnZSwgZGVlcG1lcmdlT3B0aW9ucywgZmlsdGVyQnlQcmVmaXhSZXR1cm5LZXlzIH0gZnJvbSAnLi9saWInO1xuaW1wb3J0IG1vbWVudCA9IHJlcXVpcmUoJ21vbWVudCcpO1xuaW1wb3J0IGlzUGxhaW5PYmplY3QgPSByZXF1aXJlKCdpcy1wbGFpbi1vYmplY3QnKTtcbmltcG9ydCBzb3J0T2JqZWN0S2V5cyA9IHJlcXVpcmUoJ3NvcnQtb2JqZWN0LWtleXMyJyk7XG5pbXBvcnQgSnNvbk1kIGZyb20gJy4vanNvbic7XG5pbXBvcnQgeyBlbnZWYWwsIGVudkJvb2wgfSBmcm9tICdlbnYtYm9vbCc7XG5pbXBvcnQgeyB0b0hleCB9IGZyb20gJ2hleC1saWInO1xuaW1wb3J0IHsgZXhwZWN0IH0gZnJvbSAnY2hhaSc7XG5cbmV4cG9ydCB7IG1kY29uZiwgYXJyYXlfdW5pcXVlLCBjcmxmLCBMRiB9XG5leHBvcnQgeyBkZWVwbWVyZ2UsIGRlZXBtZXJnZU9wdGlvbnMgfVxuZXhwb3J0IHsgZW52VmFsLCBlbnZCb29sIH1cblxuZXhwb3J0IHR5cGUgSU51bWJlciA9IG51bWJlciB8IHN0cmluZztcblxuZXhwb3J0IGludGVyZmFjZSBJTWRjb25mTWV0YU9wdGlvbnNCYXNlPFQgPSBhbnk+XG57XG5cdFtrZXk6IHN0cmluZ106IFQsXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSU1kY29uZk1ldGFPcHRpb25zTm92ZWxTaXRlIGV4dGVuZHMgSU1kY29uZk1ldGFPcHRpb25zQmFzZVxue1xuXHRub3ZlbF9pZD86IElOdW1iZXIsXG5cdHVybD86IHN0cmluZyxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJTWRjb25mTWV0YVxue1xuXHRub3ZlbD86IHtcblx0XHR0aXRsZT86IHN0cmluZyxcblxuXHRcdC8qKlxuXHRcdCAqIOWOn+Wni+aomemhjFxuXHRcdCAqL1xuXHRcdHRpdGxlX3NvdXJjZT86IHN0cmluZyxcblxuXHRcdC8qKlxuXHRcdCAqIOewoeefreaomemhjFxuXHRcdCAqIOWmguaenCB0aXRsZV9vdXRwdXQg5LiN5a2Y5ZyoIOmAmeWAi+WJh+acg+S9nOeCuui8uOWHuiBlcHViIOeahOaqlOWQjeWCmemBuOS5i+S4gFxuXHRcdCAqL1xuXHRcdHRpdGxlX3Nob3J0Pzogc3RyaW5nLFxuXHRcdC8qKlxuXHRcdCAqIOi8uOWHuiBlcHViIOeahOaqlOWQjVxuXHRcdCAqL1xuXHRcdHRpdGxlX291dHB1dD86IHN0cmluZyxcblxuXHRcdHRpdGxlX290aGVyPzogc3RyaW5nLFxuXG5cdFx0dGl0bGVfemgxPzogc3RyaW5nLFxuXHRcdHRpdGxlX3poMj86IHN0cmluZyxcblxuXHRcdHRpdGxlX3poPzogc3RyaW5nLFxuXHRcdHRpdGxlX2NuPzogc3RyaW5nLFxuXHRcdHRpdGxlX3R3Pzogc3RyaW5nLFxuXHRcdHRpdGxlX2VuPzogc3RyaW5nLFxuXHRcdHRpdGxlX2pwPzogc3RyaW5nLFxuXG5cdFx0LyoqXG5cdFx0ICog5L2c6ICFXG5cdFx0ICovXG5cdFx0YXV0aG9yPzogc3RyaW5nLFxuXHRcdC8qKlxuXHRcdCAqIOS9nOiAheWIl+ihqFxuXHRcdCAqL1xuXHRcdGF1dGhvcnM/OiBzdHJpbmdbXSxcblxuXHRcdC8qKlxuXHRcdCAqIOWwgemdouWcllxuXHRcdCAqL1xuXHRcdGNvdmVyPzogc3RyaW5nLFxuXHRcdC8qKlxuXHRcdCAqIOe5quW4q1xuXHRcdCAqL1xuXHRcdGlsbHVzdD86IHN0cmluZyxcblx0XHQvKipcblx0XHQgKiDnuarluKvliJfooahcblx0XHQgKi9cblx0XHRpbGx1c3RzPzogc3RyaW5nW10sXG5cblx0XHQvKipcblx0XHQgKiDnsKHku4tcblx0XHQgKi9cblx0XHRwcmVmYWNlPzogc3RyaW5nLFxuXHRcdHRhZ3M/OiBzdHJpbmdbXSxcblx0XHRkYXRlPzogc3RyaW5nLFxuXHRcdHN0YXR1cz86IHN0cmluZyxcblx0XHRyMTg/OiBzdHJpbmcsXG5cblx0XHRzZXJpZXM/OiB7XG5cdFx0XHRuYW1lPzogc3RyaW5nLFxuXHRcdFx0bmFtZV9zaG9ydD86IHN0cmluZyxcblx0XHRcdHBvc2l0aW9uPzogbnVtYmVyLFxuXHRcdH0sXG5cblx0XHQvKipcblx0XHQgKiDnmbzluIPmiJbogIXkvobmupDntrLlnYBcblx0XHQgKi9cblx0XHRzb3VyY2U/OiBzdHJpbmcsXG5cdFx0LyoqXG5cdFx0ICog55m85biD5oiW6ICF5L6G5rqQ57ay5Z2A5YiX6KGoXG5cdFx0ICovXG5cdFx0c291cmNlcz86IHN0cmluZ1tdLFxuXG5cdFx0LyoqXG5cdFx0ICog55m85biD57ay56uZ5ZCN56ix5oiW6ICF5Ye654mI56S+5ZCN56ixXG5cdFx0ICovXG5cdFx0cHVibGlzaGVyPzogc3RyaW5nLFxuXHRcdC8qKlxuXHRcdCAqIOeZvOW4g+e2suermeWQjeeoseaIluiAheWHuueJiOekvuWQjeeoseWIl+ihqFxuXHRcdCAqL1xuXHRcdHB1Ymxpc2hlcnM/OiBzdHJpbmdbXSxcblxuXHRcdC8qKlxuXHRcdCAqIOWwj+iqqueLgOaFiyBmbGFnXG5cdFx0ICovXG5cdFx0bm92ZWxfc3RhdHVzPzogRW51bU5vdmVsU3RhdHVzIHwgbnVtYmVyLFxuXHR9XG5cblx0LyoqXG5cdCAqIOe/u+itryDmoKHlsI0g5pW05ZCIIC4uLuetiSDosqLnjbvogIUg5oiWIOWFtuS7llxuXHQgKi9cblx0Y29udHJpYnV0ZT86IHN0cmluZ1tdLFxuXG5cdG9wdGlvbnM/OiBJTWRjb25mTWV0YU9wdGlvbnNCYXNlICYge1xuXG5cdFx0ZG16aj86IElNZGNvbmZNZXRhT3B0aW9uc05vdmVsU2l0ZSxcblx0XHRrYWt1eW9tdT86IElNZGNvbmZNZXRhT3B0aW9uc05vdmVsU2l0ZSxcblx0XHR3ZW5rdTg/OiBJTWRjb25mTWV0YU9wdGlvbnNOb3ZlbFNpdGUsXG5cdFx0d2VicXhzPzogSU1kY29uZk1ldGFPcHRpb25zTm92ZWxTaXRlLFxuXHRcdHN5b3NldHU/OiBJTWRjb25mTWV0YU9wdGlvbnNOb3ZlbFNpdGUgJiB7XG5cdFx0XHR0eHRkb3dubG9hZF9pZDogSU51bWJlcixcblx0XHR9LFxuXG5cdFx0bm92ZWw/OiBJTWRjb25mTWV0YU9wdGlvbnNCYXNlICYge1xuXHRcdFx0cGF0dGVybj86IHN0cmluZyxcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICog5o+Q5L6b57Wm5omT5YyF6IiH5pW055CG6IWz5pys5L2/55So55qE6Kit5a6a5YC8XG5cdFx0ICovXG5cdFx0dGV4dGxheW91dD86IElNZGNvbmZNZXRhT3B0aW9uc0Jhc2UgJiB7XG5cdFx0XHQvKipcblx0XHRcdCAqIOaYr+WQpuWFgeioseavj+S4gOihjOS5i+mWk+acieS4gOWAi+epuuihjFxuXHRcdFx0ICovXG5cdFx0XHRhbGxvd19sZjI/OiBib29sZWFuLFxuXHRcdFx0LyoqXG5cdFx0XHQgKiDmmK/lkKblhYHoqLHmr4/kuIDooYzkuYvplpPmnInlhanlgIvnqbrooYxcblx0XHRcdCAqL1xuXHRcdFx0YWxsb3dfbGYzPzogYm9vbGVhbixcblx0XHR9LFxuXG5cdFx0LyoqXG5cdFx0ICogbm92ZWwtZG93bmxvYWRlclxuXHRcdCAqL1xuXHRcdGRvd25sb2FkT3B0aW9ucz86IElNZGNvbmZNZXRhT3B0aW9uc0Jhc2UgJiB7XG5cdFx0XHRub0ZpcmVQcmVmaXg/OiBib29sZWFuLFxuXHRcdFx0bm9GaWxlUGFkZW5kPzogYm9vbGVhbixcblx0XHRcdGZpbGVQcmVmaXhNb2RlPzogbnVtYmVyLFxuXHRcdFx0c3RhcnRJbmRleD86IG51bWJlcixcblx0XHR9LFxuXG5cdH0sXG5cblx0bGluaz86IHN0cmluZ1tdLFxufVxuXG5leHBvcnQgdHlwZSBJT3B0aW9uc1BhcnNlID0gbWRjb25mLklPcHRpb25zUGFyc2UgJiB7XG5cdGNoaz86IGJvb2xlYW4sXG5cdHRocm93PzogYm9vbGVhbixcblxuXHQvKipcblx0ICog5riF6Zmk6YKE5Y6f55So55qE6LOH5paZ6aGe5Z6LXG5cdCAqL1xuXHRyZW1vdmVSYXdEYXRhPzogYm9vbGVhbixcblxuXHQvKipcblx0ICog5YWB6Kix5q6Y57y65LiN5ZCI5rOV55qEIG1ldGEgaW5mb1xuXHQgKi9cblx0bG93Q2hlY2tMZXZlbD86IGJvb2xlYW4sXG59XG5cbmV4cG9ydCBjb25zdCBkZWZhdWx0T3B0aW9uc1BhcnNlOiBJT3B0aW9uc1BhcnNlID0ge1xuXHRyZW1vdmVSYXdEYXRhOiB0cnVlLFxuXHRkaXNhYmxlS2V5VG9Mb3dlckNhc2U6IHRydWUsXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gc3RyaW5naWZ5KGRhdGEsIGQyPywgLi4uYXJndik6IHN0cmluZ1xue1xuXHRkYXRhID0gX2hhbmRsZURhdGFGb3JTdHJpbmdpZnkoZGF0YSwgZDIsIC4uLmFyZ3YpO1xuXG5cdHJldHVybiBtZGNvbmYuc3RyaW5naWZ5KGRhdGEpICsgTEYucmVwZWF0KDIpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2U8VCA9IElNZGNvbmZNZXRhPihkYXRhOiB7XG5cdHRvU3RyaW5nKCk6IHN0cmluZyxcbn0sIG9wdGlvbnM/OiBJT3B0aW9uc1BhcnNlKTogVFxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlPFQgPSBJTWRjb25mTWV0YT4oZGF0YTogc3RyaW5nLCBvcHRpb25zPzogSU9wdGlvbnNQYXJzZSk6IFRcbmV4cG9ydCBmdW5jdGlvbiBwYXJzZTxUIGV4dGVuZHMgSU1kY29uZk1ldGE+KGRhdGEsIG9wdGlvbnM6IElPcHRpb25zUGFyc2UgPSB7fSk6IFRcbntcblx0aWYgKG9wdGlvbnMucmVtb3ZlUmF3RGF0YSlcblx0e1xuXHRcdG9wdGlvbnMub2xkUGFyc2VBcGkgPSBvcHRpb25zLnJlbW92ZVJhd0RhdGE7XG5cdH1cblxuXHRpZiAob3B0aW9ucy5kaXNhYmxlS2V5VG9Mb3dlckNhc2UgPT0gbnVsbClcblx0e1xuXHRcdG9wdGlvbnMuZGlzYWJsZUtleVRvTG93ZXJDYXNlID0gdHJ1ZTtcblx0fVxuXG5cdGxldCByZXQgPSBtZGNvbmYucGFyc2UoY3JsZihkYXRhLnRvU3RyaW5nKCkpLCBvcHRpb25zKSBhcyBJTWRjb25mTWV0YTtcblxuXHR0cnlcblx0e1xuXHRcdGlmIChyZXQubm92ZWwgJiYgcmV0Lm5vdmVsLnByZWZhY2UpXG5cdFx0e1xuXHRcdFx0cmV0Lm5vdmVsLnByZWZhY2UgPSAocmV0Lm5vdmVsLnByZWZhY2Vcblx0XHRcdFx0JiYgcmV0Lm5vdmVsLnByZWZhY2UubGVuZ3RoXG5cdFx0XHRcdCYmIEFycmF5LmlzQXJyYXkocmV0Lm5vdmVsLnByZWZhY2UpKSA/IHJldC5ub3ZlbC5wcmVmYWNlLmpvaW4oTEYpIDogcmV0Lm5vdmVsLnByZWZhY2Vcblx0XHRcdDtcblx0XHR9XG5cblx0XHRpZiAoIW9wdGlvbnMubG93Q2hlY2tMZXZlbCB8fCByZXQub3B0aW9ucylcblx0XHR7XG5cdFx0XHRyZXQub3B0aW9ucyA9IGRlZXBtZXJnZShyZXQub3B0aW9ucyB8fCB7fSwge1xuXG5cdFx0XHRcdHRleHRsYXlvdXQ6IHt9LFxuXG5cdFx0XHR9LCBkZWVwbWVyZ2VPcHRpb25zKTtcblx0XHR9XG5cdH1cblx0Y2F0Y2ggKGUpXG5cdHtcblx0XHRjb25zb2xlLmVycm9yKGUudG9TdHJpbmcoKSk7XG5cdH1cblxuXHRpZiAob3B0aW9ucy5jaGsgfHwgb3B0aW9ucy5jaGsgPT0gbnVsbClcblx0e1xuXHRcdHJldCA9IGNoa0luZm8ocmV0LCBvcHRpb25zKTtcblx0fVxuXG5cdGlmIChvcHRpb25zLnRocm93IHx8IG9wdGlvbnMudGhyb3cgPT0gbnVsbClcblx0e1xuXHRcdHJldCA9IGNoa0luZm8ocmV0LCBvcHRpb25zKTtcblxuXHRcdGlmICghcmV0KVxuXHRcdHtcblx0XHRcdHRocm93IG5ldyBFcnJvcignbWRjb25mX3BhcnNlJyk7XG5cdFx0fVxuXHR9XG5cblx0aWYgKHJldClcblx0e1xuXHRcdHJldCA9IHNvcnRLZXlzKHJldCk7XG5cblx0XHQvL2NvbnNvbGUubG9nKDc3Nyk7XG5cdH1cblxuXHQvLyBAdHMtaWdub3JlXG5cdHJldHVybiByZXQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBfaGFuZGxlRGF0YTxUIGV4dGVuZHMgSU1kY29uZk1ldGE+KGRhdGEsIGQyPywgLi4uYXJndik6IFRcbntcblx0Ly8gQHRzLWlnbm9yZVxuXHRkYXRhID0gSnNvbk1kLnRvTm92ZWxJbmZvKGRhdGEsIGQyIHx8IHt9LCB7XG5cdFx0bm92ZWw6IHtcblx0XHRcdHRhZ3M6IFtdLFxuXHRcdH0sXG5cdH0sIC4uLmFyZ3YpO1xuXG5cdGRhdGEgPSBzb3J0S2V5cyhkYXRhKTtcblx0ZGF0YS5ub3ZlbC50YWdzLnVuc2hpZnQoJ25vZGUtbm92ZWwnKTtcblx0ZGF0YS5ub3ZlbC50YWdzID0gYXJyYXlfdW5pcXVlKGRhdGEubm92ZWwudGFncyk7XG5cblx0Ly8gQHRzLWlnbm9yZVxuXHRyZXR1cm4gZGF0YTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9oYW5kbGVEYXRhRm9yU3RyaW5naWZ5PFQgZXh0ZW5kcyBJTWRjb25mTWV0YT4oZGF0YSwgZDI/LCAuLi5hcmd2KTogVFxue1xuXHRkYXRhID0gX2hhbmRsZURhdGEoZGF0YSwgZDIsIC4uLmFyZ3YpO1xuXG5cdGlmIChkYXRhLm5vdmVsLnByZWZhY2UgJiYgdHlwZW9mIGRhdGEubm92ZWwucHJlZmFjZSA9PSAnc3RyaW5nJylcblx0e1xuXHRcdGRhdGEubm92ZWwucHJlZmFjZSA9IG5ldyBtZGNvbmYuUmF3T2JqZWN0KGRhdGEubm92ZWwucHJlZmFjZSwge30pO1xuXHR9XG5cblx0aWYgKCdub3ZlbF9zdGF0dXMnIGluIGRhdGEubm92ZWwpXG5cdHtcblx0XHRleHBlY3QoZGF0YS5ub3ZlbC5ub3ZlbF9zdGF0dXMpLmEoJ251bWJlcicpO1xuXG5cdFx0ZGF0YS5ub3ZlbC5ub3ZlbF9zdGF0dXMgPSB0b0hleChkYXRhLm5vdmVsLm5vdmVsX3N0YXR1cywgNCk7XG5cdH1cblxuXHQvLyBAdHMtaWdub3JlXG5cdHJldHVybiBkYXRhO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc29ydEtleXM8VCBleHRlbmRzIElNZGNvbmZNZXRhPihyZXQ6IFQpXG57XG5cdC8vIEB0cy1pZ25vcmVcblx0cmV0ID0gc29ydE9iamVjdEtleXMocmV0LCBbXG5cdFx0J25vdmVsJyxcblx0XHQnY29udHJpYnV0ZScsXG5cdFx0J29wdGlvbnMnLFxuXHRdKTtcblxuXHRzb3J0U3ViS2V5KCdub3ZlbCcsIFtcblx0XHQndGl0bGUnLFxuXHRcdCd0aXRsZV9zaG9ydCcsXG5cdFx0J3RpdGxlX3poJyxcblx0XHQndGl0bGVfemgxJyxcblx0XHQndGl0bGVfemgyJyxcblx0XHQndGl0bGVfZW4nLFxuXHRcdCd0aXRsZV9qcCcsXG5cdFx0J3RpdGxlX291dHB1dCcsXG5cdFx0J3RpdGxlX290aGVyJyxcblx0XHQndGl0bGVfc291cmNlJyxcblx0XHQnYXV0aG9yJyxcblx0XHQnYXV0aG9ycycsXG5cdFx0J2lsbHVzdCcsXG5cdFx0J2lsbHVzdHMnLFxuXHRcdCdzb3VyY2UnLFxuXHRcdCdjb3ZlcicsXG5cdFx0J3B1Ymxpc2hlcicsXG5cdFx0J3B1Ymxpc2hlcnMnLFxuXHRcdCdkYXRlJyxcblx0XHQnc3RhdHVzJyxcblx0XHQnbm92ZWxfc3RhdHVzJyxcblx0XHQncjE4JyxcblxuXHRcdCdzZXJpZXMnLFxuXG5cdFx0J3ByZWZhY2UnLFxuXHRcdCd0YWdzJyxcblx0XSk7XG5cblx0c29ydFN1YktleShbJ25vdmVsJywgJ3RhZ3MnXSwgbnVsbCwgdHJ1ZSk7XG5cdHNvcnRTdWJLZXkoJ2NvbnRyaWJ1dGUnLCBudWxsLCB0cnVlKTtcblx0c29ydFN1YktleSgnb3B0aW9ucycpO1xuXG5cdGZ1bmN0aW9uIHNvcnRTdWJLZXkoa2V5LCBzb3J0TGlzdD86IHN0cmluZ1tdLCB1bmlxdWU/OiBib29sZWFuKVxuXHR7XG5cdFx0bGV0IG9iaiA9IHJldDtcblx0XHRsZXQgcGFyZW50ID0gb2JqO1xuXG5cdFx0Ly9jb25zb2xlLmxvZyhvYmosIHNvcnRMaXN0KTtcblxuXHRcdGlmIChBcnJheS5pc0FycmF5KGtleSkpXG5cdFx0e1xuXHRcdFx0Ly9jb25zb2xlLmxvZyhrZXkpO1xuXG5cdFx0XHRsZXQgX2s7XG5cblx0XHRcdGZvciAobGV0IHZhbHVlIG9mIGtleSlcblx0XHRcdHtcblx0XHRcdFx0aWYgKCEodmFsdWUgaW4gb2JqKSlcblx0XHRcdFx0e1xuXHRcdFx0XHRcdC8vY29uc29sZS5sb2codmFsdWUsIHBhcmVudCk7XG5cblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRfayA9IHZhbHVlO1xuXG5cdFx0XHRcdHBhcmVudCA9IG9iajtcblx0XHRcdFx0b2JqID0gcGFyZW50W3ZhbHVlXTtcblx0XHRcdH1cblxuXHRcdFx0a2V5ID0gX2s7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKChrZXkgaW4gcGFyZW50KSlcblx0XHR7XG5cdFx0XHRvYmogPSBwYXJlbnRba2V5XTtcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRpZiAoQXJyYXkuaXNBcnJheShvYmopKVxuXHRcdHtcblx0XHRcdG9iai5zb3J0KCk7XG5cdFx0XHRwYXJlbnRba2V5XSA9IG9iajtcblx0XHRcdGlmICh1bmlxdWUpXG5cdFx0XHR7XG5cdFx0XHRcdHBhcmVudFtrZXldID0gcGFyZW50W2tleV0uZmlsdGVyKGZ1bmN0aW9uICh2KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmV0dXJuIHY7XG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdHBhcmVudFtrZXldID0gYXJyYXlfdW5pcXVlKHBhcmVudFtrZXldKTtcblxuXHRcdFx0XHRpZiAocGFyZW50W2tleV0ubGVuZ3RoID09IDEgJiYgKHBhcmVudFtrZXldWzBdID09PSBudWxsIHx8IHR5cGVvZiBwYXJlbnRba2V5XVswXSA9PSAndW5kZWZpbmVkJykpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRwYXJlbnRba2V5XSA9IFtdO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0aWYgKGlzUGxhaW5PYmplY3Qob2JqKSlcblx0XHR7XG5cdFx0XHRwYXJlbnRba2V5XSA9IHNvcnRPYmplY3RLZXlzKG9iaiwgc29ydExpc3QpO1xuXHRcdH1cblx0fVxuXG5cdC8vIEB0cy1pZ25vcmVcblx0cmV0dXJuIHJldDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNoa0luZm8ocmV0OiBJTWRjb25mTWV0YSwgb3B0aW9uczogSU9wdGlvbnNQYXJzZSA9IHt9KTogSU1kY29uZk1ldGFcbntcblx0aWYgKCFyZXRcblx0XHR8fCAoXG5cdFx0XHQoIW9wdGlvbnMgfHwgIW9wdGlvbnMubG93Q2hlY2tMZXZlbClcblx0XHRcdCYmICghcmV0Lm5vdmVsIHx8ICFyZXQubm92ZWwudGl0bGUpXG5cdFx0KVxuXHQpXG5cdHtcblx0XHRyZXR1cm4gbnVsbDtcblx0fVxuXG5cdGlmIChyZXQubm92ZWwpXG5cdHtcblx0XHRbXG5cdFx0XHQnYXV0aG9ycycsXG5cdFx0XHQnaWxsdXN0cycsXG5cdFx0XHQndGFncycsXG5cdFx0XHQnc291cmNlcycsXG5cdFx0XHQncHVibGlzaGVycycsXG5cdFx0XS5mb3JFYWNoKGsgPT4ge1xuXHRcdFx0aWYgKGsgaW4gcmV0Lm5vdmVsKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXQubm92ZWxba10gPSBhbnlUb0FycmF5KHJldC5ub3ZlbFtrXSwgdHJ1ZSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRpZiAoJ25vdmVsX3N0YXR1cycgaW4gcmV0Lm5vdmVsKVxuXHRcdHtcblx0XHRcdHJldC5ub3ZlbC5ub3ZlbF9zdGF0dXMgPSBlbnZWYWwocmV0Lm5vdmVsLm5vdmVsX3N0YXR1cyk7XG5cblx0XHRcdGlmICh0eXBlb2YgcmV0Lm5vdmVsLm5vdmVsX3N0YXR1cyA9PT0gJ3N0cmluZycgJiYgL14weFtcXGRhLWZdKyQvLnRlc3QocmV0Lm5vdmVsLm5vdmVsX3N0YXR1cykpXG5cdFx0XHR7XG5cdFx0XHRcdHJldC5ub3ZlbC5ub3ZlbF9zdGF0dXMgPSBOdW1iZXIocmV0Lm5vdmVsLm5vdmVsX3N0YXR1cyk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0aWYgKCdjb250cmlidXRlJyBpbiByZXQpXG5cdHtcblx0XHRyZXQuY29udHJpYnV0ZSA9IGFueVRvQXJyYXkocmV0LmNvbnRyaWJ1dGUsIHRydWUpO1xuXHR9XG5cblx0aWYgKCFvcHRpb25zLmxvd0NoZWNrTGV2ZWwpXG5cdHtcblx0XHRyZXQub3B0aW9ucyA9IHJldC5vcHRpb25zIHx8IHt9O1xuXHR9XG5cblx0aWYgKHJldC5vcHRpb25zKVxuXHR7XG5cdFx0aWYgKHR5cGVvZiByZXQub3B0aW9ucy50ZXh0bGF5b3V0ID09PSAnb2JqZWN0Jylcblx0XHR7XG5cdFx0XHRPYmplY3QuZW50cmllcyhyZXQub3B0aW9ucy50ZXh0bGF5b3V0KVxuXHRcdFx0XHQuZm9yRWFjaCgoW2ssIHZdKSA9PiByZXQub3B0aW9ucy50ZXh0bGF5b3V0W2tdID0gZW52VmFsKHYpKVxuXHRcdFx0O1xuXHRcdH1cblxuXHRcdGlmICh0eXBlb2YgcmV0Lm9wdGlvbnMuZG93bmxvYWRPcHRpb25zID09PSAnb2JqZWN0Jylcblx0XHR7XG5cdFx0XHRPYmplY3QuZW50cmllcyhyZXQub3B0aW9ucy5kb3dubG9hZE9wdGlvbnMpXG5cdFx0XHRcdC5mb3JFYWNoKChbaywgdl0pID0+IHJldC5vcHRpb25zLmRvd25sb2FkT3B0aW9uc1trXSA9IGVudlZhbCh2KSlcblx0XHRcdDtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gcmV0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Tm92ZWxUaXRsZUZyb21NZXRhKG1ldGE6IElNZGNvbmZNZXRhKTogc3RyaW5nW11cbntcblx0aWYgKG1ldGEgJiYgbWV0YS5ub3ZlbClcblx0e1xuXHRcdGxldCBhcnIgPSBbXG5cdFx0XHRcdCd0aXRsZScsXG5cdFx0XHRcdCd0aXRsZV9zb3VyY2UnLFxuXHRcdFx0XHQndGl0bGVfanAnLFxuXHRcdFx0XHQndGl0bGVfamEnLFxuXHRcdFx0XHQndGl0bGVfemgnLFxuXHRcdFx0XHQndGl0bGVfdHcnLFxuXHRcdFx0XHQndGl0bGVfY24nLFxuXHRcdFx0XS5jb25jYXQoZmlsdGVyQnlQcmVmaXhSZXR1cm5LZXlzKCd0aXRsZV8nLCBtZXRhLm5vdmVsKSlcblx0XHRcdC5yZWR1Y2UoZnVuY3Rpb24gKGEsIGtleTogc3RyaW5nKVxuXHRcdFx0e1xuXHRcdFx0XHRpZiAoa2V5IGluIG1ldGEubm92ZWwpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRhLnB1c2gobWV0YS5ub3ZlbFtrZXldKVxuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmV0dXJuIGFcblx0XHRcdH0sIFtdKVxuXHRcdDtcblxuXHRcdGlmIChtZXRhLm5vdmVsLnNlcmllcylcblx0XHR7XG5cdFx0XHRhcnIucHVzaChtZXRhLm5vdmVsLnNlcmllcy5uYW1lKTtcblx0XHRcdGFyci5wdXNoKG1ldGEubm92ZWwuc2VyaWVzLm5hbWVfc2hvcnQpO1xuXHRcdH1cblxuXHRcdGFyciA9IGFycmF5X3VuaXF1ZShhcnIuZmlsdGVyKHYgPT4gdiAmJiAhW1xuXHRcdFx0J3VuZGVmaW5lZCcsXG5cdFx0XHQn6ZW357eoIOOAkOmAo+i8ieOAkScsXG5cdFx0XHQn6YCj6LyJ5LitJyxcblx0XHRdLmluY2x1ZGVzKHYpKSk7XG5cblx0XHRyZXR1cm4gYXJyO1xuXHR9XG5cblx0cmV0dXJuIFtdO1xufVxuXG5mdW5jdGlvbiBhbnlUb0FycmF5PFQgPSBzdHJpbmc+KGlucHV0OiBUIHwgVFtdLCB1bmlxdWU/OiBib29sZWFuKTogVFtdXG57XG5cdGlmICh0eXBlb2YgaW5wdXQgIT0gJ29iamVjdCcpXG5cdHtcblx0XHRpbnB1dCA9IFtpbnB1dF07XG5cdH1cblxuXHRpZiAodW5pcXVlKVxuXHR7XG5cdFx0aW5wdXQgPSBhcnJheV91bmlxdWUoaW5wdXQgfHwgW10pO1xuXHR9XG5cblx0Ly8gQHRzLWlnbm9yZVxuXHRyZXR1cm4gaW5wdXQ7XG59XG5cbmV4cG9ydCBjb25zdCB2ZXJzaW9uOiBzdHJpbmcgPSByZXF1aXJlKFwiLi9wYWNrYWdlLmpzb25cIikudmVyc2lvbjtcblxuZXhwb3J0IGNvbnN0IG1kY29uZl9wYXJzZSA9IHBhcnNlO1xuXG5leHBvcnQgZGVmYXVsdCBleHBvcnRzIGFzIHR5cGVvZiBpbXBvcnQoJy4vaW5kZXgnKTtcbiJdfQ==