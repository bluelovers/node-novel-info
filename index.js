"use strict";
/**
 * Created by user on 2018/1/27/027.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const mdconf = require("mdconf2");
exports.mdconf = mdconf;
const crlf_normalize_1 = require("crlf-normalize");
exports.crlf = crlf_normalize_1.crlf;
exports.LF = crlf_normalize_1.LF;
const lib_1 = require("./lib");
exports.array_unique = lib_1.array_unique;
exports.deepmerge = lib_1.deepmerge;
exports.deepmergeOptions = lib_1.deepmergeOptions;
const isPlainObject = require("is-plain-object");
const sortObjectKeys = require("sort-object-keys2");
const json_1 = require("./json");
const env_bool_1 = require("env-bool");
exports.envVal = env_bool_1.envVal;
exports.envBool = env_bool_1.envBool;
const hex_lib_1 = require("hex-lib");
const chai_1 = require("chai");
exports.defaultOptionsParse = {
    removeRawData: true,
    disableKeyToLowerCase: true,
};
function stringify(data, d2, ...argv) {
    data = _handleDataForStringify(data, d2, ...argv);
    return mdconf.stringify(data) + crlf_normalize_1.LF.repeat(2);
}
exports.stringify = stringify;
function parse(data, options = {}) {
    if (options.removeRawData) {
        options.oldParseApi = options.removeRawData;
    }
    if (options.disableKeyToLowerCase == null) {
        options.disableKeyToLowerCase = true;
    }
    let ret = mdconf.parse(crlf_normalize_1.crlf(data.toString()), options);
    try {
        if (ret.novel.preface) {
            ret.novel.preface = (ret.novel.preface
                && ret.novel.preface.length
                && Array.isArray(ret.novel.preface)) ? ret.novel.preface.join(crlf_normalize_1.LF) : ret.novel.preface;
        }
        ret.options = lib_1.deepmerge(ret.options || {}, {
            textlayout: {},
        }, lib_1.deepmergeOptions);
    }
    catch (e) {
        console.error(e.toString());
    }
    if (options.chk || options.chk == null) {
        ret = chkInfo(ret, options);
    }
    if (options.throw || options.throw == null) {
        ret = chkInfo(ret, options);
        if (!ret) {
            throw new Error('mdconf_parse');
        }
    }
    if (ret) {
        ret = sortKeys(ret);
        //console.log(777);
    }
    // @ts-ignore
    return ret;
}
exports.parse = parse;
function _handleData(data, d2, ...argv) {
    // @ts-ignore
    data = json_1.default.toNovelInfo(data, d2 || {}, {
        novel: {
            tags: [],
        },
    }, ...argv);
    data = sortKeys(data);
    data.novel.tags.unshift('node-novel');
    data.novel.tags = lib_1.array_unique(data.novel.tags);
    // @ts-ignore
    return data;
}
exports._handleData = _handleData;
function _handleDataForStringify(data, d2, ...argv) {
    data = _handleData(data, d2, ...argv);
    if (data.novel.preface && typeof data.novel.preface == 'string') {
        data.novel.preface = new mdconf.RawObject(data.novel.preface, {});
    }
    if ('novel_status' in data.novel) {
        chai_1.expect(data.novel.novel_status).a('number');
        data.novel.novel_status = hex_lib_1.toHex(data.novel.novel_status, 4);
    }
    // @ts-ignore
    return data;
}
exports._handleDataForStringify = _handleDataForStringify;
function sortKeys(ret) {
    // @ts-ignore
    ret = sortObjectKeys(ret, [
        'novel',
        'contribute',
        'options',
    ]);
    sortSubKey('novel', [
        'title',
        'title_short',
        'title_zh',
        'title_zh1',
        'title_zh2',
        'title_en',
        'title_jp',
        'title_output',
        'title_other',
        'title_source',
        'author',
        'authors',
        'illust',
        'illusts',
        'source',
        'cover',
        'publisher',
        'publishers',
        'date',
        'status',
        'novel_status',
        'r18',
        'series',
        'preface',
        'tags',
    ]);
    sortSubKey(['novel', 'tags'], null, true);
    sortSubKey('contribute', null, true);
    sortSubKey('options');
    function sortSubKey(key, sortList, unique) {
        let obj = ret;
        let parent = obj;
        //console.log(obj, sortList);
        if (Array.isArray(key)) {
            //console.log(key);
            let _k;
            for (let value of key) {
                if (!(value in obj)) {
                    //console.log(value, parent);
                    return;
                }
                _k = value;
                parent = obj;
                obj = parent[value];
            }
            key = _k;
        }
        else if ((key in parent)) {
            obj = parent[key];
        }
        else {
            return;
        }
        if (Array.isArray(obj)) {
            obj.sort();
            parent[key] = obj;
            if (unique) {
                parent[key] = parent[key].filter(function (v) {
                    return v;
                });
                parent[key] = lib_1.array_unique(parent[key]);
                if (parent[key].length == 1 && (parent[key][0] === null || typeof parent[key][0] == 'undefined')) {
                    parent[key] = [];
                }
            }
            return;
        }
        if (isPlainObject(obj)) {
            parent[key] = sortObjectKeys(obj, sortList);
        }
    }
    // @ts-ignore
    return ret;
}
exports.sortKeys = sortKeys;
function chkInfo(ret, options = {}) {
    if (!ret
        || ((!options || !options.lowCheckLevel)
            && (!ret.novel || !ret.novel.title))) {
        return null;
    }
    if (ret.novel) {
        [
            'authors',
            'illusts',
            'tags',
            'sources',
            'publishers',
        ].forEach(k => {
            if (k in ret.novel) {
                ret.novel[k] = anyToArray(ret.novel[k], true);
            }
        });
        if ('novel_status' in ret.novel) {
            ret.novel.novel_status = env_bool_1.envVal(ret.novel.novel_status);
            if (typeof ret.novel.novel_status === 'string' && /^0x[\da-f]+$/.test(ret.novel.novel_status)) {
                ret.novel.novel_status = Number(ret.novel.novel_status);
            }
        }
    }
    if ('contribute' in ret) {
        ret.contribute = anyToArray(ret.contribute, true);
    }
    ret.options = ret.options || {};
    if (typeof ret.options.textlayout === 'object') {
        Object.entries(ret.options.textlayout)
            .forEach(([k, v]) => ret.options.textlayout[k] = env_bool_1.envVal(v));
    }
    if (typeof ret.options.downloadOptions === 'object') {
        Object.entries(ret.options.downloadOptions)
            .forEach(([k, v]) => ret.options.downloadOptions[k] = env_bool_1.envVal(v));
    }
    return ret;
}
exports.chkInfo = chkInfo;
function getNovelTitleFromMeta(meta) {
    if (meta && meta.novel) {
        let arr = [
            'title',
            'title_source',
            'title_jp',
            'title_ja',
            'title_zh',
            'title_tw',
            'title_cn',
        ].concat(Object.keys(meta.novel))
            .reduce(function (a, key) {
            if (key.indexOf('title') === 0) {
                a.push(meta.novel[key]);
            }
            return a;
        }, []);
        if (meta.novel.series) {
            arr.push(meta.novel.series.name);
            arr.push(meta.novel.series.name_short);
        }
        arr = lib_1.array_unique(arr.filter(v => v && ![
            'undefined',
            '長編 【連載】',
            '連載中',
        ].includes(v)));
        return arr;
    }
    return [];
}
exports.getNovelTitleFromMeta = getNovelTitleFromMeta;
function anyToArray(input, unique) {
    if (typeof input != 'object') {
        input = [input];
    }
    if (unique) {
        input = lib_1.array_unique(input || []);
    }
    // @ts-ignore
    return input;
}
exports.version = require("./package.json").version;
exports.mdconf_parse = parse;
exports.default = exports;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBR0gsa0NBQW1DO0FBVzFCLHdCQUFNO0FBVmYsbURBQTBDO0FBVVgsZUFWdEIscUJBQUksQ0FVc0I7QUFBRSxhQVZ0QixtQkFBRSxDQVVzQjtBQVR2QywrQkFBa0U7QUFTakQsdUJBVFIsa0JBQVksQ0FTUTtBQUNwQixvQkFWYyxlQUFTLENBVWQ7QUFBRSwyQkFWYyxzQkFBZ0IsQ0FVZDtBQVJwQyxpREFBa0Q7QUFDbEQsb0RBQXFEO0FBQ3JELGlDQUE0QjtBQUM1Qix1Q0FBMkM7QUFNbEMsaUJBTkEsaUJBQU0sQ0FNQTtBQUFFLGtCQU5BLGtCQUFPLENBTUE7QUFMeEIscUNBQWdDO0FBQ2hDLCtCQUE4QjtBQTZJakIsUUFBQSxtQkFBbUIsR0FBa0I7SUFDakQsYUFBYSxFQUFFLElBQUk7SUFDbkIscUJBQXFCLEVBQUUsSUFBSTtDQUMzQixDQUFDO0FBRUYsU0FBZ0IsU0FBUyxDQUFDLElBQUksRUFBRSxFQUFHLEVBQUUsR0FBRyxJQUFJO0lBRTNDLElBQUksR0FBRyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFFbEQsT0FBTyxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLG1CQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzlDLENBQUM7QUFMRCw4QkFLQztBQU1ELFNBQWdCLEtBQUssQ0FBd0IsSUFBSSxFQUFFLFVBQXlCLEVBQUU7SUFFN0UsSUFBSSxPQUFPLENBQUMsYUFBYSxFQUN6QjtRQUNDLE9BQU8sQ0FBQyxXQUFXLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQztLQUM1QztJQUVELElBQUksT0FBTyxDQUFDLHFCQUFxQixJQUFJLElBQUksRUFDekM7UUFDQyxPQUFPLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFD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LE9BQU8sR0FBRyxDQUFDO0tBQ1g7SUFFRCxPQUFPLEVBQUUsQ0FBQztBQUNYLENBQUM7QUF4Q0Qsc0RBd0NDO0FBRUQsU0FBUyxVQUFVLENBQWEsS0FBYyxFQUFFLE1BQWdCO0lBRS9ELElBQUksT0FBTyxLQUFLLElBQUksUUFBUSxFQUM1QjtRQUNDLEtBQUssR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ2hCO0lBRUQsSUFBSSxNQUFNLEVBQ1Y7UUFDQyxLQUFLLEdBQUcsa0JBQVksQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLENBQUM7S0FDbEM7SUFFRCxhQUFhO0lBQ2IsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDO0FBRVksUUFBQSxPQUFPLEdBQVcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUMsT0FBTyxDQUFDO0FBRXBELFFBQUEsWUFBWSxHQUFHLEtBQUssQ0FBQztBQUVsQyxrQkFBZSxPQUFtQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjAxOC8xLzI3LzAyNy5cbiAqL1xuXG5pbXBvcnQgeyBFbnVtTm92ZWxTdGF0dXMgfSBmcm9tICcuL2xpYi9jb25zdCc7XG5pbXBvcnQgbWRjb25mID0gcmVxdWlyZSgnbWRjb25mMicpO1xuaW1wb3J0IHsgY3JsZiwgTEYgfSBmcm9tICdjcmxmLW5vcm1hbGl6ZSc7XG5pbXBvcnQgeyBhcnJheV91bmlxdWUsIGRlZXBtZXJnZSwgZGVlcG1lcmdlT3B0aW9ucyB9IGZyb20gJy4vbGliJztcbmltcG9ydCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKTtcbmltcG9ydCBpc1BsYWluT2JqZWN0ID0gcmVxdWlyZSgnaXMtcGxhaW4tb2JqZWN0Jyk7XG5pbXBvcnQgc29ydE9iamVjdEtleXMgPSByZXF1aXJlKCdzb3J0LW9iamVjdC1rZXlzMicpO1xuaW1wb3J0IEpzb25NZCBmcm9tICcuL2pzb24nO1xuaW1wb3J0IHsgZW52VmFsLCBlbnZCb29sIH0gZnJvbSAnZW52LWJvb2wnO1xuaW1wb3J0IHsgdG9IZXggfSBmcm9tICdoZXgtbGliJztcbmltcG9ydCB7IGV4cGVjdCB9IGZyb20gJ2NoYWknO1xuXG5leHBvcnQgeyBtZGNvbmYsIGFycmF5X3VuaXF1ZSwgY3JsZiwgTEYgfVxuZXhwb3J0IHsgZGVlcG1lcmdlLCBkZWVwbWVyZ2VPcHRpb25zIH1cbmV4cG9ydCB7IGVudlZhbCwgZW52Qm9vbCB9XG5cbmV4cG9ydCB0eXBlIElOdW1iZXIgPSBudW1iZXIgfCBzdHJpbmc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSU1kY29uZk1ldGFPcHRpb25zQmFzZTxUID0gYW55Plxue1xuXHRba2V5OiBzdHJpbmddOiBULFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElNZGNvbmZNZXRhT3B0aW9uc05vdmVsU2l0ZSBleHRlbmRzIElNZGNvbmZNZXRhT3B0aW9uc0Jhc2Vcbntcblx0bm92ZWxfaWQ/OiBJTnVtYmVyLFxuXHR1cmw/OiBzdHJpbmcsXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSU1kY29uZk1ldGFcbntcblx0bm92ZWw/OiB7XG5cdFx0dGl0bGU/OiBzdHJpbmcsXG5cblx0XHQvKipcblx0XHQgKiDljp/lp4vmqJnpoYxcblx0XHQgKi9cblx0XHR0aXRsZV9zb3VyY2U/OiBzdHJpbmcsXG5cblx0XHQvKipcblx0XHQgKiDnsKHnn63mqJnpoYxcblx0XHQgKiDlpoLmnpwgdGl0bGVfb3V0cHV0IOS4jeWtmOWcqCDpgJnlgIvliYfmnIPkvZzngrrovLjlh7ogZXB1YiDnmoTmqpTlkI3lgpnpgbjkuYvkuIBcblx0XHQgKi9cblx0XHR0aXRsZV9zaG9ydD86IHN0cmluZyxcblx0XHQvKipcblx0XHQgKiDovLjlh7ogZXB1YiDnmoTmqpTlkI1cblx0XHQgKi9cblx0XHR0aXRsZV9vdXRwdXQ/OiBzdHJpbmcsXG5cblx0XHR0aXRsZV9vdGhlcj86IHN0cmluZyxcblxuXHRcdHRpdGxlX3poMT86IHN0cmluZyxcblx0XHR0aXRsZV96aDI/OiBzdHJpbmcsXG5cblx0XHR0aXRsZV96aD86IHN0cmluZyxcblx0XHR0aXRsZV9jbj86IHN0cmluZyxcblx0XHR0aXRsZV90dz86IHN0cmluZyxcblx0XHR0aXRsZV9lbj86IHN0cmluZyxcblx0XHR0aXRsZV9qcD86IHN0cmluZyxcblxuXHRcdGF1dGhvcj86IHN0cmluZyxcblx0XHRhdXRob3JzPzogc3RyaW5nW10sXG5cblx0XHQvKipcblx0XHQgKiDlsIHpnaLlnJZcblx0XHQgKi9cblx0XHRjb3Zlcj86IHN0cmluZyxcblx0XHQvKipcblx0XHQgKiDnuarluKtcblx0XHQgKi9cblx0XHRpbGx1c3Q/OiBzdHJpbmcsXG5cdFx0aWxsdXN0cz86IHN0cmluZ1tdLFxuXG5cdFx0LyoqXG5cdFx0ICog57Ch5LuLXG5cdFx0ICovXG5cdFx0cHJlZmFjZT86IHN0cmluZyxcblx0XHR0YWdzPzogc3RyaW5nW10sXG5cdFx0ZGF0ZT86IHN0cmluZyxcblx0XHRzdGF0dXM/OiBzdHJpbmcsXG5cdFx0cjE4Pzogc3RyaW5nLFxuXG5cdFx0c2VyaWVzPzoge1xuXHRcdFx0bmFtZT86IHN0cmluZyxcblx0XHRcdG5hbWVfc2hvcnQ/OiBzdHJpbmcsXG5cdFx0XHRwb3NpdGlvbj86IG51bWJlcixcblx0XHR9LFxuXG5cdFx0c291cmNlPzogc3RyaW5nLFxuXHRcdHNvdXJjZXM/OiBzdHJpbmdbXSxcblxuXHRcdHB1Ymxpc2hlcj86IHN0cmluZyxcblx0XHRwdWJsaXNoZXJzPzogc3RyaW5nW10sXG5cblx0XHQvKipcblx0XHQgKiDlsI/oqqrni4DmhYsgZmxhZ1xuXHRcdCAqL1xuXHRcdG5vdmVsX3N0YXR1cz86IEVudW1Ob3ZlbFN0YXR1cyB8IG51bWJlcixcblx0fVxuXG5cdC8qKlxuXHQgKiDnv7vora8g5qCh5bCNIOaVtOWQiCAuLi7nrYkg6LKi54276ICFIOaIliDlhbbku5Zcblx0ICovXG5cdGNvbnRyaWJ1dGU/OiBzdHJpbmdbXSxcblxuXHRvcHRpb25zPzogSU1kY29uZk1ldGFPcHRpb25zQmFzZSAmIHtcblxuXHRcdGRtemo/OiBJTWRjb25mTWV0YU9wdGlvbnNOb3ZlbFNpdGUsXG5cdFx0a2FrdXlvbXU/OiBJTWRjb25mTWV0YU9wdGlvbnNOb3ZlbFNpdGUsXG5cdFx0d2Vua3U4PzogSU1kY29uZk1ldGFPcHRpb25zTm92ZWxTaXRlLFxuXHRcdHdlYnF4cz86IElNZGNvbmZNZXRhT3B0aW9uc05vdmVsU2l0ZSxcblx0XHRzeW9zZXR1PzogSU1kY29uZk1ldGFPcHRpb25zTm92ZWxTaXRlICYge1xuXHRcdFx0dHh0ZG93bmxvYWRfaWQ6IElOdW1iZXIsXG5cdFx0fSxcblxuXHRcdG5vdmVsPzogSU1kY29uZk1ldGFPcHRpb25zQmFzZSAmIHtcblx0XHRcdHBhdHRlcm4/OiBzdHJpbmcsXG5cdFx0fSxcblxuXHRcdHRleHRsYXlvdXQ/OiBJTWRjb25mTWV0YU9wdGlvbnNCYXNlICYge1xuXHRcdFx0YWxsb3dfbGYyPzogYm9vbGVhbixcblx0XHRcdGFsbG93X2xmMz86IGJvb2xlYW4sXG5cdFx0fSxcblxuXHRcdC8qKlxuXHRcdCAqIG5vdmVsLWRvd25sb2FkZXJcblx0XHQgKi9cblx0XHRkb3dubG9hZE9wdGlvbnM/OiBJTWRjb25mTWV0YU9wdGlvbnNCYXNlICYge1xuXHRcdFx0bm9GaXJlUHJlZml4PzogYm9vbGVhbixcblx0XHRcdG5vRmlsZVBhZGVuZD86IGJvb2xlYW4sXG5cdFx0XHRmaWxlUHJlZml4TW9kZT86IG51bWJlcixcblx0XHRcdHN0YXJ0SW5kZXg/OiBudW1iZXIsXG5cdFx0fSxcblxuXHR9LFxuXG5cdGxpbms/OiBzdHJpbmdbXSxcbn1cblxuZXhwb3J0IHR5cGUgSU9wdGlvbnNQYXJzZSA9IG1kY29uZi5JT3B0aW9uc1BhcnNlICYge1xuXHRjaGs/OiBib29sZWFuLFxuXHR0aHJvdz86IGJvb2xlYW4sXG5cblx0cmVtb3ZlUmF3RGF0YT86IGJvb2xlYW4sXG5cblx0LyoqXG5cdCAqIOWFgeioseaumOe8uuS4jeWQiOazleeahCBtZXRhIGluZm9cblx0ICovXG5cdGxvd0NoZWNrTGV2ZWw/OiBib29sZWFuLFxufVxuXG5leHBvcnQgY29uc3QgZGVmYXVsdE9wdGlvbnNQYXJzZTogSU9wdGlvbnNQYXJzZSA9IHtcblx0cmVtb3ZlUmF3RGF0YTogdHJ1ZSxcblx0ZGlzYWJsZUtleVRvTG93ZXJDYXNlOiB0cnVlLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHN0cmluZ2lmeShkYXRhLCBkMj8sIC4uLmFyZ3YpOiBzdHJpbmdcbntcblx0ZGF0YSA9IF9oYW5kbGVEYXRhRm9yU3RyaW5naWZ5KGRhdGEsIGQyLCAuLi5hcmd2KTtcblxuXHRyZXR1cm4gbWRjb25mLnN0cmluZ2lmeShkYXRhKSArIExGLnJlcGVhdCgyKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlPFQgPSBJTWRjb25mTWV0YT4oZGF0YToge1xuXHR0b1N0cmluZygpOiBzdHJpbmcsXG59LCBvcHRpb25zPzogSU9wdGlvbnNQYXJzZSk6IFRcbmV4cG9ydCBmdW5jdGlvbiBwYXJzZTxUID0gSU1kY29uZk1ldGE+KGRhdGE6IHN0cmluZywgb3B0aW9ucz86IElPcHRpb25zUGFyc2UpOiBUXG5leHBvcnQgZnVuY3Rpb24gcGFyc2U8VCBleHRlbmRzIElNZGNvbmZNZXRhPihkYXRhLCBvcHRpb25zOiBJT3B0aW9uc1BhcnNlID0ge30pOiBUXG57XG5cdGlmIChvcHRpb25zLnJlbW92ZVJhd0RhdGEpXG5cdHtcblx0XHRvcHRpb25zLm9sZFBhcnNlQXBpID0gb3B0aW9ucy5yZW1vdmVSYXdEYXRhO1xuXHR9XG5cblx0aWYgKG9wdGlvbnMuZGlzYWJsZUtleVRvTG93ZXJDYXNlID09IG51bGwpXG5cdHtcblx0XHRvcHRpb25zLmRpc2FibGVLZXlUb0xvd2VyQ2FzZSA9IHRydWU7XG5cdH1cblxuXHRsZXQgcmV0ID0gbWRjb25mLnBhcnNlKGNybGYoZGF0YS50b1N0cmluZygpKSwgb3B0aW9ucykgYXMgSU1kY29uZk1ldGE7XG5cblx0dHJ5XG5cdHtcblx0XHRpZiAocmV0Lm5vdmVsLnByZWZhY2UpXG5cdFx0e1xuXHRcdFx0cmV0Lm5vdmVsLnByZWZhY2UgPSAocmV0Lm5vdmVsLnByZWZhY2Vcblx0XHRcdFx0JiYgcmV0Lm5vdmVsLnByZWZhY2UubGVuZ3RoXG5cdFx0XHRcdCYmIEFycmF5LmlzQXJyYXkocmV0Lm5vdmVsLnByZWZhY2UpKSA/IHJldC5ub3ZlbC5wcmVmYWNlLmpvaW4oTEYpIDogcmV0Lm5vdmVsLnByZWZhY2Vcblx0XHRcdDtcblx0XHR9XG5cblx0XHRyZXQub3B0aW9ucyA9IGRlZXBtZXJnZShyZXQub3B0aW9ucyB8fCB7fSwge1xuXG5cdFx0XHR0ZXh0bGF5b3V0OiB7fSxcblxuXHRcdH0sIGRlZXBtZXJnZU9wdGlvbnMpO1xuXHR9XG5cdGNhdGNoIChlKVxuXHR7XG5cdFx0Y29uc29sZS5lcnJvcihlLnRvU3RyaW5nKCkpO1xuXHR9XG5cblx0aWYgKG9wdGlvbnMuY2hrIHx8IG9wdGlvbnMuY2hrID09IG51bGwpXG5cdHtcblx0XHRyZXQgPSBjaGtJbmZvKHJldCwgb3B0aW9ucyk7XG5cdH1cblxuXHRpZiAob3B0aW9ucy50aHJvdyB8fCBvcHRpb25zLnRocm93ID09IG51bGwpXG5cdHtcblx0XHRyZXQgPSBjaGtJbmZvKHJldCwgb3B0aW9ucyk7XG5cblx0XHRpZiAoIXJldClcblx0XHR7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ21kY29uZl9wYXJzZScpO1xuXHRcdH1cblx0fVxuXG5cdGlmIChyZXQpXG5cdHtcblx0XHRyZXQgPSBzb3J0S2V5cyhyZXQpO1xuXG5cdFx0Ly9jb25zb2xlLmxvZyg3NzcpO1xuXHR9XG5cblx0Ly8gQHRzLWlnbm9yZVxuXHRyZXR1cm4gcmV0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX2hhbmRsZURhdGE8VCBleHRlbmRzIElNZGNvbmZNZXRhPihkYXRhLCBkMj8sIC4uLmFyZ3YpOiBUXG57XG5cdC8vIEB0cy1pZ25vcmVcblx0ZGF0YSA9IEpzb25NZC50b05vdmVsSW5mbyhkYXRhLCBkMiB8fCB7fSwge1xuXHRcdG5vdmVsOiB7XG5cdFx0XHR0YWdzOiBbXSxcblx0XHR9LFxuXHR9LCAuLi5hcmd2KTtcblxuXHRkYXRhID0gc29ydEtleXMoZGF0YSk7XG5cdGRhdGEubm92ZWwudGFncy51bnNoaWZ0KCdub2RlLW5vdmVsJyk7XG5cdGRhdGEubm92ZWwudGFncyA9IGFycmF5X3VuaXF1ZShkYXRhLm5vdmVsLnRhZ3MpO1xuXG5cdC8vIEB0cy1pZ25vcmVcblx0cmV0dXJuIGRhdGE7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBfaGFuZGxlRGF0YUZvclN0cmluZ2lmeTxUIGV4dGVuZHMgSU1kY29uZk1ldGE+KGRhdGEsIGQyPywgLi4uYXJndik6IFRcbntcblx0ZGF0YSA9IF9oYW5kbGVEYXRhKGRhdGEsIGQyLCAuLi5hcmd2KTtcblxuXHRpZiAoZGF0YS5ub3ZlbC5wcmVmYWNlICYmIHR5cGVvZiBkYXRhLm5vdmVsLnByZWZhY2UgPT0gJ3N0cmluZycpXG5cdHtcblx0XHRkYXRhLm5vdmVsLnByZWZhY2UgPSBuZXcgbWRjb25mLlJhd09iamVjdChkYXRhLm5vdmVsLnByZWZhY2UsIHt9KTtcblx0fVxuXG5cdGlmICgnbm92ZWxfc3RhdHVzJyBpbiBkYXRhLm5vdmVsKVxuXHR7XG5cdFx0ZXhwZWN0KGRhdGEubm92ZWwubm92ZWxfc3RhdHVzKS5hKCdudW1iZXInKTtcblxuXHRcdGRhdGEubm92ZWwubm92ZWxfc3RhdHVzID0gdG9IZXgoZGF0YS5ub3ZlbC5ub3ZlbF9zdGF0dXMsIDQpO1xuXHR9XG5cblx0Ly8gQHRzLWlnbm9yZVxuXHRyZXR1cm4gZGF0YTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNvcnRLZXlzPFQgZXh0ZW5kcyBJTWRjb25mTWV0YT4ocmV0OiBUKVxue1xuXHQvLyBAdHMtaWdub3JlXG5cdHJldCA9IHNvcnRPYmplY3RLZXlzKHJldCwgW1xuXHRcdCdub3ZlbCcsXG5cdFx0J2NvbnRyaWJ1dGUnLFxuXHRcdCdvcHRpb25zJyxcblx0XSk7XG5cblx0c29ydFN1YktleSgnbm92ZWwnLCBbXG5cdFx0J3RpdGxlJyxcblx0XHQndGl0bGVfc2hvcnQnLFxuXHRcdCd0aXRsZV96aCcsXG5cdFx0J3RpdGxlX3poMScsXG5cdFx0J3RpdGxlX3poMicsXG5cdFx0J3RpdGxlX2VuJyxcblx0XHQndGl0bGVfanAnLFxuXHRcdCd0aXRsZV9vdXRwdXQnLFxuXHRcdCd0aXRsZV9vdGhlcicsXG5cdFx0J3RpdGxlX3NvdXJjZScsXG5cdFx0J2F1dGhvcicsXG5cdFx0J2F1dGhvcnMnLFxuXHRcdCdpbGx1c3QnLFxuXHRcdCdpbGx1c3RzJyxcblx0XHQnc291cmNlJyxcblx0XHQnY292ZXInLFxuXHRcdCdwdWJsaXNoZXInLFxuXHRcdCdwdWJsaXNoZXJzJyxcblx0XHQnZGF0ZScsXG5cdFx0J3N0YXR1cycsXG5cdFx0J25vdmVsX3N0YXR1cycsXG5cdFx0J3IxOCcsXG5cblx0XHQnc2VyaWVzJyxcblxuXHRcdCdwcmVmYWNlJyxcblx0XHQndGFncycsXG5cdF0pO1xuXG5cdHNvcnRTdWJLZXkoWydub3ZlbCcsICd0YWdzJ10sIG51bGwsIHRydWUpO1xuXHRzb3J0U3ViS2V5KCdjb250cmlidXRlJywgbnVsbCwgdHJ1ZSk7XG5cdHNvcnRTdWJLZXkoJ29wdGlvbnMnKTtcblxuXHRmdW5jdGlvbiBzb3J0U3ViS2V5KGtleSwgc29ydExpc3Q/OiBzdHJpbmdbXSwgdW5pcXVlPzogYm9vbGVhbilcblx0e1xuXHRcdGxldCBvYmogPSByZXQ7XG5cdFx0bGV0IHBhcmVudCA9IG9iajtcblxuXHRcdC8vY29uc29sZS5sb2cob2JqLCBzb3J0TGlzdCk7XG5cblx0XHRpZiAoQXJyYXkuaXNBcnJheShrZXkpKVxuXHRcdHtcblx0XHRcdC8vY29uc29sZS5sb2coa2V5KTtcblxuXHRcdFx0bGV0IF9rO1xuXG5cdFx0XHRmb3IgKGxldCB2YWx1ZSBvZiBrZXkpXG5cdFx0XHR7XG5cdFx0XHRcdGlmICghKHZhbHVlIGluIG9iaikpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHQvL2NvbnNvbGUubG9nKHZhbHVlLCBwYXJlbnQpO1xuXG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0X2sgPSB2YWx1ZTtcblxuXHRcdFx0XHRwYXJlbnQgPSBvYmo7XG5cdFx0XHRcdG9iaiA9IHBhcmVudFt2YWx1ZV07XG5cdFx0XHR9XG5cblx0XHRcdGtleSA9IF9rO1xuXHRcdH1cblx0XHRlbHNlIGlmICgoa2V5IGluIHBhcmVudCkpXG5cdFx0e1xuXHRcdFx0b2JqID0gcGFyZW50W2tleV07XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKEFycmF5LmlzQXJyYXkob2JqKSlcblx0XHR7XG5cdFx0XHRvYmouc29ydCgpO1xuXHRcdFx0cGFyZW50W2tleV0gPSBvYmo7XG5cdFx0XHRpZiAodW5pcXVlKVxuXHRcdFx0e1xuXHRcdFx0XHRwYXJlbnRba2V5XSA9IHBhcmVudFtrZXldLmZpbHRlcihmdW5jdGlvbiAodilcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHJldHVybiB2O1xuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRwYXJlbnRba2V5XSA9IGFycmF5X3VuaXF1ZShwYXJlbnRba2V5XSk7XG5cblx0XHRcdFx0aWYgKHBhcmVudFtrZXldLmxlbmd0aCA9PSAxICYmIChwYXJlbnRba2V5XVswXSA9PT0gbnVsbCB8fCB0eXBlb2YgcGFyZW50W2tleV1bMF0gPT0gJ3VuZGVmaW5lZCcpKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cGFyZW50W2tleV0gPSBbXTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdGlmIChpc1BsYWluT2JqZWN0KG9iaikpXG5cdFx0e1xuXHRcdFx0cGFyZW50W2tleV0gPSBzb3J0T2JqZWN0S2V5cyhvYmosIHNvcnRMaXN0KTtcblx0XHR9XG5cdH1cblxuXHQvLyBAdHMtaWdub3JlXG5cdHJldHVybiByZXQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjaGtJbmZvKHJldDogSU1kY29uZk1ldGEsIG9wdGlvbnM6IElPcHRpb25zUGFyc2UgPSB7fSk6IElNZGNvbmZNZXRhXG57XG5cdGlmICghcmV0XG5cdFx0fHwgKFxuXHRcdFx0KCFvcHRpb25zIHx8ICFvcHRpb25zLmxvd0NoZWNrTGV2ZWwpXG5cdFx0XHQmJiAoIXJldC5ub3ZlbCB8fCAhcmV0Lm5vdmVsLnRpdGxlKVxuXHRcdClcblx0KVxuXHR7XG5cdFx0cmV0dXJuIG51bGw7XG5cdH1cblxuXHRpZiAocmV0Lm5vdmVsKVxuXHR7XG5cdFx0W1xuXHRcdFx0J2F1dGhvcnMnLFxuXHRcdFx0J2lsbHVzdHMnLFxuXHRcdFx0J3RhZ3MnLFxuXHRcdFx0J3NvdXJjZXMnLFxuXHRcdFx0J3B1Ymxpc2hlcnMnLFxuXHRcdF0uZm9yRWFjaChrID0+IHtcblx0XHRcdGlmIChrIGluIHJldC5ub3ZlbClcblx0XHRcdHtcblx0XHRcdFx0cmV0Lm5vdmVsW2tdID0gYW55VG9BcnJheShyZXQubm92ZWxba10sIHRydWUpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdFx0aWYgKCdub3ZlbF9zdGF0dXMnIGluIHJldC5ub3ZlbClcblx0XHR7XG5cdFx0XHRyZXQubm92ZWwubm92ZWxfc3RhdHVzID0gZW52VmFsKHJldC5ub3ZlbC5ub3ZlbF9zdGF0dXMpO1xuXG5cdFx0XHRpZiAodHlwZW9mIHJldC5ub3ZlbC5ub3ZlbF9zdGF0dXMgPT09ICdzdHJpbmcnICYmIC9eMHhbXFxkYS1mXSskLy50ZXN0KHJldC5ub3ZlbC5ub3ZlbF9zdGF0dXMpKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXQubm92ZWwubm92ZWxfc3RhdHVzID0gTnVtYmVyKHJldC5ub3ZlbC5ub3ZlbF9zdGF0dXMpO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdGlmICgnY29udHJpYnV0ZScgaW4gcmV0KVxuXHR7XG5cdFx0cmV0LmNvbnRyaWJ1dGUgPSBhbnlUb0FycmF5KHJldC5jb250cmlidXRlLCB0cnVlKTtcblx0fVxuXG5cdHJldC5vcHRpb25zID0gcmV0Lm9wdGlvbnMgfHwge307XG5cblx0aWYgKHR5cGVvZiByZXQub3B0aW9ucy50ZXh0bGF5b3V0ID09PSAnb2JqZWN0Jylcblx0e1xuXHRcdE9iamVjdC5lbnRyaWVzKHJldC5vcHRpb25zLnRleHRsYXlvdXQpXG5cdFx0XHQuZm9yRWFjaCgoW2ssIHZdKSA9PiByZXQub3B0aW9ucy50ZXh0bGF5b3V0W2tdID0gZW52VmFsKHYpKVxuXHRcdDtcblx0fVxuXG5cdGlmICh0eXBlb2YgcmV0Lm9wdGlvbnMuZG93bmxvYWRPcHRpb25zID09PSAnb2JqZWN0Jylcblx0e1xuXHRcdE9iamVjdC5lbnRyaWVzKHJldC5vcHRpb25zLmRvd25sb2FkT3B0aW9ucylcblx0XHRcdC5mb3JFYWNoKChbaywgdl0pID0+IHJldC5vcHRpb25zLmRvd25sb2FkT3B0aW9uc1trXSA9IGVudlZhbCh2KSlcblx0XHQ7XG5cdH1cblxuXHRyZXR1cm4gcmV0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Tm92ZWxUaXRsZUZyb21NZXRhKG1ldGE6IElNZGNvbmZNZXRhKTogc3RyaW5nW11cbntcblx0aWYgKG1ldGEgJiYgbWV0YS5ub3ZlbClcblx0e1xuXHRcdGxldCBhcnIgPSBbXG5cdFx0XHRcdCd0aXRsZScsXG5cdFx0XHRcdCd0aXRsZV9zb3VyY2UnLFxuXHRcdFx0XHQndGl0bGVfanAnLFxuXHRcdFx0XHQndGl0bGVfamEnLFxuXHRcdFx0XHQndGl0bGVfemgnLFxuXHRcdFx0XHQndGl0bGVfdHcnLFxuXHRcdFx0XHQndGl0bGVfY24nLFxuXHRcdFx0XS5jb25jYXQoT2JqZWN0LmtleXMobWV0YS5ub3ZlbCkpXG5cdFx0XHQucmVkdWNlKGZ1bmN0aW9uIChhLCBrZXk6IHN0cmluZylcblx0XHRcdHtcblx0XHRcdFx0aWYgKGtleS5pbmRleE9mKCd0aXRsZScpID09PSAwKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0YS5wdXNoKG1ldGEubm92ZWxba2V5XSlcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHJldHVybiBhXG5cdFx0XHR9LCBbXSlcblx0XHQ7XG5cblx0XHRpZiAobWV0YS5ub3ZlbC5zZXJpZXMpXG5cdFx0e1xuXHRcdFx0YXJyLnB1c2gobWV0YS5ub3ZlbC5zZXJpZXMubmFtZSk7XG5cdFx0XHRhcnIucHVzaChtZXRhLm5vdmVsLnNlcmllcy5uYW1lX3Nob3J0KTtcblx0XHR9XG5cblx0XHRhcnIgPSBhcnJheV91bmlxdWUoYXJyLmZpbHRlcih2ID0+IHYgJiYgIVtcblx0XHRcdCd1bmRlZmluZWQnLFxuXHRcdFx0J+mVt+e3qCDjgJDpgKPovInjgJEnLFxuXHRcdFx0J+mAo+i8ieS4rScsXG5cdFx0XS5pbmNsdWRlcyh2KSkpO1xuXG5cdFx0cmV0dXJuIGFycjtcblx0fVxuXG5cdHJldHVybiBbXTtcbn1cblxuZnVuY3Rpb24gYW55VG9BcnJheTxUID0gc3RyaW5nPihpbnB1dDogVCB8IFRbXSwgdW5pcXVlPzogYm9vbGVhbik6IFRbXVxue1xuXHRpZiAodHlwZW9mIGlucHV0ICE9ICdvYmplY3QnKVxuXHR7XG5cdFx0aW5wdXQgPSBbaW5wdXRdO1xuXHR9XG5cblx0aWYgKHVuaXF1ZSlcblx0e1xuXHRcdGlucHV0ID0gYXJyYXlfdW5pcXVlKGlucHV0IHx8IFtdKTtcblx0fVxuXG5cdC8vIEB0cy1pZ25vcmVcblx0cmV0dXJuIGlucHV0O1xufVxuXG5leHBvcnQgY29uc3QgdmVyc2lvbjogc3RyaW5nID0gcmVxdWlyZShcIi4vcGFja2FnZS5qc29uXCIpLnZlcnNpb247XG5cbmV4cG9ydCBjb25zdCBtZGNvbmZfcGFyc2UgPSBwYXJzZTtcblxuZXhwb3J0IGRlZmF1bHQgZXhwb3J0cyBhcyB0eXBlb2YgaW1wb3J0KCcuL2luZGV4Jyk7XG4iXX0=