"use strict";
/**
 * Created by user on 2018/1/27/027.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const mdconf = require("mdconf2");
exports.mdconf = mdconf;
const crlf_normalize_1 = require("crlf-normalize");
exports.crlf = crlf_normalize_1.crlf;
exports.LF = crlf_normalize_1.LF;
const lib_1 = require("./lib");
exports.array_unique = lib_1.array_unique;
exports.deepmerge = lib_1.deepmerge;
exports.deepmergeOptions = lib_1.deepmergeOptions;
const isPlainObject = require("is-plain-object");
const sortObjectKeys = require("sort-object-keys2");
const json_1 = require("./json");
const env_bool_1 = require("env-bool");
exports.envVal = env_bool_1.envVal;
exports.envBool = env_bool_1.envBool;
exports.defaultOptionsParse = {
    removeRawData: true,
};
function stringify(data, d2, ...argv) {
    data = json_1.default.toNovelInfo(data, d2 || {}, {
        novel: {
            tags: [],
        },
    }, ...argv);
    data = sortKeys(data);
    data.novel.tags.unshift('node-novel');
    data.novel.tags = lib_1.array_unique(data.novel.tags);
    if (data.novel.preface && typeof data.novel.preface == 'string') {
        data.novel.preface = new mdconf.RawObject(data.novel.preface, {});
    }
    return mdconf.stringify(data) + crlf_normalize_1.LF.repeat(2);
}
exports.stringify = stringify;
function parse(data, options = {}) {
    if (options.removeRawData) {
        options.oldParseApi = options.removeRawData;
    }
    let ret = mdconf.parse(crlf_normalize_1.crlf(data.toString()), options);
    try {
        if (ret.novel.preface) {
            ret.novel.preface = (ret.novel.preface
                && ret.novel.preface.length
                && Array.isArray(ret.novel.preface)) ? ret.novel.preface.join(crlf_normalize_1.LF) : ret.novel.preface;
        }
        ret.options = lib_1.deepmerge(ret.options || {}, {
            textlayout: {},
        }, lib_1.deepmergeOptions);
    }
    catch (e) {
        console.error(e.toString());
    }
    if (options.chk || options.chk == null) {
        ret = chkInfo(ret, options);
    }
    if (options.throw || options.throw == null) {
        ret = chkInfo(ret, options);
        if (!ret) {
            throw new Error('mdconf_parse');
        }
    }
    if (ret) {
        ret = sortKeys(ret);
        //console.log(777);
    }
    return ret;
}
exports.parse = parse;
function sortKeys(ret) {
    ret = sortObjectKeys(ret, [
        'novel',
        'contribute',
        'options',
    ]);
    sortSubKey('novel', [
        'title',
        'title_short',
        'title_zh',
        'title_en',
        'title_jp',
        'author',
        'source',
        'cover',
        'publisher',
        'date',
        'status',
        'r18',
        'series',
        'preface',
        'tags',
    ]);
    sortSubKey(['novel', 'tags'], null, true);
    sortSubKey('contribute', null, true);
    sortSubKey('options');
    function sortSubKey(key, sortList, unique) {
        let obj = ret;
        let parent = obj;
        //console.log(obj, sortList);
        if (Array.isArray(key)) {
            //console.log(key);
            let _k;
            for (let value of key) {
                if (!(value in obj)) {
                    //console.log(value, parent);
                    return;
                }
                _k = value;
                parent = obj;
                obj = parent[value];
            }
            key = _k;
        }
        else if ((key in parent)) {
            obj = parent[key];
        }
        else {
            return;
        }
        if (Array.isArray(obj)) {
            obj.sort();
            parent[key] = obj;
            if (unique) {
                parent[key] = parent[key].filter(function (v) {
                    return v;
                });
                parent[key] = lib_1.array_unique(parent[key]);
                if (parent[key].length == 1 && (parent[key][0] === null || typeof parent[key][0] == 'undefined')) {
                    parent[key] = [];
                }
            }
            return;
        }
        if (isPlainObject(obj)) {
            parent[key] = sortObjectKeys(obj, sortList);
        }
    }
    return ret;
}
exports.sortKeys = sortKeys;
function chkInfo(ret, options = {}) {
    if (!ret
        || ((!options || !options.lowCheckLevel)
            && (!ret.novel || !ret.novel.title))) {
        return null;
    }
    if (ret.novel) {
        [
            'authors',
            'illust',
            'tags',
            'sources',
        ].forEach(k => {
            if (k in ret.novel) {
                ret.novel[k] = anyToArray(ret.novel[k], true);
            }
        });
    }
    if ('contribute' in ret) {
        ret.contribute = anyToArray(ret.contribute, true);
    }
    ret.options = ret.options || {};
    if (typeof ret.options.textlayout === 'object') {
        Object.entries(ret.options.textlayout)
            .forEach(([k, v]) => ret.options.textlayout[k] = env_bool_1.envVal(v));
    }
    if (typeof ret.options.downloadoptions === 'object') {
        Object.entries(ret.options.downloadoptions)
            .forEach(([k, v]) => ret.options.downloadoptions[k] = env_bool_1.envVal(v));
    }
    return ret;
}
exports.chkInfo = chkInfo;
function anyToArray(input, unique) {
    if (typeof input != 'object') {
        input = [input];
    }
    if (unique) {
        input = lib_1.array_unique(input || []);
    }
    // @ts-ignore
    return input;
}
exports.version = require("./package.json").version;
const self = require("./index");
exports.mdconf_parse = self.parse;
exports.default = self;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsa0NBQWtDO0FBU3pCLHdCQUFNO0FBUmYsbURBQTBDO0FBUVgsZUFSdEIscUJBQUksQ0FRc0I7QUFBRSxhQVJ0QixtQkFBRSxDQVFzQjtBQVB2QywrQkFBa0U7QUFPakQsdUJBUFIsa0JBQVksQ0FPUTtBQUNwQixvQkFSYyxlQUFTLENBUWQ7QUFBRSwyQkFSYyxzQkFBZ0IsQ0FRZDtBQU5wQyxpREFBaUQ7QUFDakQsb0RBQW9EO0FBQ3BELGlDQUE0QjtBQUM1Qix1Q0FBMkM7QUFJbEMsaUJBSkEsaUJBQU0sQ0FJQTtBQUFFLGtCQUpBLGtCQUFPLENBSUE7QUEwRlgsUUFBQSxtQkFBbUIsR0FBa0I7SUFDakQsYUFBYSxFQUFFLElBQUk7Q0FDbkIsQ0FBQztBQUVGLFNBQWdCLFNBQVMsQ0FBQyxJQUFJLEVBQUUsRUFBRyxFQUFFLEdBQUcsSUFBSTtJQUUzQyxJQUFJLEdBQUcsY0FBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRTtRQUN6QyxLQUFLLEVBQUU7WUFDTixJQUFJLEVBQUUsRUFBRTtTQUNSO0tBQ0QsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO0lBRVosSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDdEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsa0JBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRWhELElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sSUFBSSxRQUFRLEVBQy9EO1FBQ0MsSUFBSSxDQUFDLEtBQUss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QUFLLElBQUksRUFBRSxDQUFDLENBQUM7S0FDbEM7SUFFRCxhQUFhO0lBQ2IsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDO0FBRVksUUFBQSxPQUFPLEdBQVcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUMsT0FBTyxDQUFDO0FBRWpFLGdDQUFnQztBQUVsQixRQUFBLFlBQVksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO0FBRXhDLGtCQUFlLElBQUksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTgvMS8yNy8wMjcuXG4gKi9cblxuaW1wb3J0ICogYXMgbWRjb25mIGZyb20gJ21kY29uZjInO1xuaW1wb3J0IHsgY3JsZiwgTEYgfSBmcm9tICdjcmxmLW5vcm1hbGl6ZSc7XG5pbXBvcnQgeyBhcnJheV91bmlxdWUsIGRlZXBtZXJnZSwgZGVlcG1lcmdlT3B0aW9ucyB9IGZyb20gJy4vbGliJztcbmltcG9ydCAqIGFzIG1vbWVudCBmcm9tICdtb21lbnQnO1xuaW1wb3J0ICogYXMgaXNQbGFpbk9iamVjdCBmcm9tICdpcy1wbGFpbi1vYmplY3QnO1xuaW1wb3J0ICogYXMgc29ydE9iamVjdEtleXMgZnJvbSAnc29ydC1vYmplY3Qta2V5czInO1xuaW1wb3J0IEpzb25NZCBmcm9tICcuL2pzb24nO1xuaW1wb3J0IHsgZW52VmFsLCBlbnZCb29sIH0gZnJvbSAnZW52LWJvb2wnO1xuXG5leHBvcnQgeyBtZGNvbmYsIGFycmF5X3VuaXF1ZSwgY3JsZiwgTEYgfVxuZXhwb3J0IHsgZGVlcG1lcmdlLCBkZWVwbWVyZ2VPcHRpb25zIH1cbmV4cG9ydCB7IGVudlZhbCwgZW52Qm9vbCB9XG5cbmV4cG9ydCB0eXBlIElOdW1iZXIgPSBudW1iZXIgfCBzdHJpbmc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSU1kY29uZk1ldGFPcHRpb25zTm92ZWxTaXRlXG57XG5cdG5vdmVsX2lkPzogSU51bWJlcixcblx0dXJsPzogc3RyaW5nLFxuXHRba2V5OiBzdHJpbmddOiBhbnksXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSU1kY29uZk1ldGFcbntcblx0bm92ZWw/OiB7XG5cdFx0dGl0bGU/OiBzdHJpbmcsXG5cdFx0dGl0bGVfc291cmNlPzogc3RyaW5nLFxuXG5cdFx0dGl0bGVfc2hvcnQ/OiBzdHJpbmcsXG5cdFx0dGl0bGVfb3V0cHV0Pzogc3RyaW5nLFxuXG5cdFx0dGl0bGVfemg/OiBzdHJpbmcsXG5cdFx0dGl0bGVfY24/OiBzdHJpbmcsXG5cdFx0dGl0bGVfdHc/OiBzdHJpbmcsXG5cdFx0dGl0bGVfZW4/OiBzdHJpbmcsXG5cdFx0dGl0bGVfanA/OiBzdHJpbmcsXG5cblx0XHRhdXRob3I/OiBzdHJpbmcsXG5cdFx0YXV0aG9ycz86IHN0cmluZ1tdLFxuXG5cdFx0Y292ZXI/OiBzdHJpbmcsXG5cdFx0aWxsdXN0Pzogc3RyaW5nW10sXG5cblx0XHRwcmVmYWNlPzogc3RyaW5nLFxuXHRcdHRhZ3M/OiBzdHJpbmdbXSxcblx0XHRkYXRlPzogc3RyaW5nLFxuXHRcdHN0YXR1cz86IHN0cmluZyxcblx0XHRyMTg/OiBzdHJpbmcsXG5cblx0XHRzZXJpZXM/OiB7XG5cdFx0XHRuYW1lPzogc3RyaW5nLFxuXHRcdFx0bmFtZV9zaG9ydD86IHN0cmluZyxcblx0XHRcdHBvc2l0aW9uPzogbnVtYmVyLFxuXHRcdH0sXG5cblx0XHRzb3VyY2U/OiBzdHJpbmcsXG5cdFx0c291cmNlcz86IHN0cmluZ1tdLFxuXG5cdFx0cHVibGlzaGVyPzogc3RyaW5nLFxuXHR9XG5cblx0Y29udHJpYnV0ZT86IHN0cmluZ1tdLFxuXG5cdG9wdGlvbnM/OiB7XG5cblx0XHRkbXpqPzogSU1kY29uZk1ldGFPcHRpb25zTm92ZWxTaXRlLFxuXHRcdGtha3V5b211PzogSU1kY29uZk1ldGFPcHRpb25zTm92ZWxTaXRlLFxuXHRcdHdlbmt1OD86IElNZGNvbmZNZXRhT3B0aW9uc05vdmVsU2l0ZSxcblx0XHR3ZWJxeHM/OiBJTWRjb25mTWV0YU9wdGlvbnNOb3ZlbFNpdGUsXG5cdFx0c3lvc2V0dT86IElNZGNvbmZNZXRhT3B0aW9uc05vdmVsU2l0ZSAmIHtcblx0XHRcdHR4dGRvd25sb2FkX2lkOiBJTnVtYmVyLFxuXHRcdH0sXG5cblx0XHRub3ZlbD86IHtcblx0XHRcdHBhdHRlcm4/OiBzdHJpbmcsXG5cdFx0XHRba2V5OiBzdHJpbmddOiBhbnksXG5cdFx0fSxcblxuXHRcdHRleHRsYXlvdXQ/OiB7XG5cdFx0XHRhbGxvd19sZjI/OiBib29sZWFuLFxuXHRcdFx0W2tleTogc3RyaW5nXTogYW55LFxuXHRcdH0sXG5cdFx0W2tleTogc3RyaW5nXTogYW55LFxuXHR9LFxuXG5cdGxpbms/OiBzdHJpbmdbXSxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJT3B0aW9uc1BhcnNlIGV4dGVuZHMgbWRjb25mLklPcHRpb25zUGFyc2Vcbntcblx0Y2hrPzogYm9vbGVhbixcblx0dGhyb3c/OiBib29sZWFuLFxuXG5cdHJlbW92ZVJhd0RhdGE/OiBib29sZWFuLFxuXG5cdC8qKlxuXHQgKiDlhYHoqLHmrpjnvLrkuI3lkIjms5XnmoQgbWV0YSBpbmZvXG5cdCAqL1xuXHRsb3dDaGVja0xldmVsPzogYm9vbGVhbixcbn1cblxuZXhwb3J0IGNvbnN0IGRlZmF1bHRPcHRpb25zUGFyc2U6IElPcHRpb25zUGFyc2UgPSB7XG5cdHJlbW92ZVJhd0RhdGE6IHRydWUsXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gc3RyaW5naWZ5KGRhdGEsIGQyPywgLi4uYXJndik6IHN0cmluZ1xue1xuXHRkYXRhID0gSnNvbk1kLnRvTm92ZWxJbmZvKGRhdGEsIGQyIHx8IHt9LCB7XG5cdFx0bm92ZWw6IHtcblx0XHRcdHRhZ3M6IFtdLFxuXHRcdH0sXG5cdH0sIC4uLmFyZ3YpO1xuXG5cdGRhdGEgPSBzb3J0S2V5cyhkYXRhKTtcblx0ZGF0YS5ub3ZlbC50YWdzLnVuc2hpZnQoJ25vZGUtbm92ZWwnKTtcblx0ZGF0YS5ub3ZlbC50YWdzID0gYXJyYXlfdW5pcXVlKGRhdGEubm92ZWwudGFncyk7XG5cblx0aWYgKGRhdGEubm92ZWwucHJlZmFjZSAmJiB0eXBlb2YgZGF0YS5ub3ZlbC5wcmVmYWNlID09ICdzdHJpbmcnKVxuXHR7XG5cdFx0ZGF0YS5ub3ZlbC5wcmVmYWNlID0gbmV3IG1kY29uZi5SYXdPYmplY3QoZGF0YS5ub3ZlbC5wcmVmYWNlLCB7fSk7XG5cdH1cblxuXHRyZXR1cm4gbWRjb25mLnN0cmluZ2lmeShkYXRhKSArIExGLnJlcGVhdCgyKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlKGRhdGE6IHtcblx0dG9TdHJpbmcoKTogc3RyaW5nLFxufSwgb3B0aW9ucz86IElPcHRpb25zUGFyc2UpOiBJTWRjb25mTWV0YVxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlKGRhdGE6IHN0cmluZywgb3B0aW9ucz86IElPcHRpb25zUGFyc2UpOiBJTWRjb25mTWV0YVxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlKGRhdGEsIG9wdGlvbnM6IElPcHRpb25zUGFyc2UgPSB7fSk6IElNZGNvbmZNZXRhXG57XG5cdGlmIChvcHRpb25zLnJlbW92ZVJhd0RhdGEpXG5cdHtcblx0XHRvcHRpb25zLm9sZFBhcnNlQXBpID0gb3B0aW9ucy5yZW1vdmVSYXdEYXRhO1xuXHR9XG5cblx0bGV0IHJldCA9IG1kY29uZi5wYXJzZShjcmxmKGRhdGEudG9TdHJpbmcoKSksIG9wdGlvbnMpIGFzIElNZGNvbmZNZXRhO1xuXG5cdHRyeVxuXHR7XG5cdFx0aWYgKHJldC5ub3ZlbC5wcmVmYWNlKVxuXHRcdHtcblx0XHRcdHJldC5ub3ZlbC5wcmVmYWNlID0gKHJldC5ub3ZlbC5wcmVmYWNlXG5cdFx0XHRcdCYmIHJldC5ub3ZlbC5wcmVmYWNlLmxlbmd0aFxuXHRcdFx0XHQmJiBBcnJheS5pc0FycmF5KHJldC5ub3ZlbC5wcmVmYWNlKSkgPyByZXQubm92ZWwucHJlZmFjZS5qb2luKExGKSA6IHJldC5ub3ZlbC5wcmVmYWNlXG5cdFx0XHQ7XG5cdFx0fVxuXG5cdFx0cmV0Lm9wdGlvbnMgPSBkZWVwbWVyZ2UocmV0Lm9wdGlvbnMgfHwge30sIHtcblxuXHRcdFx0dGV4dGxheW91dDoge30sXG5cblx0XHR9LCBkZWVwbWVyZ2VPcHRpb25zKTtcblx0fVxuXHRjYXRjaCAoZSlcblx0e1xuXHRcdGNvbnNvbGUuZXJyb3IoZS50b1N0cmluZygpKTtcblx0fVxuXG5cdGlmIChvcHRpb25zLmNoayB8fCBvcHRpb25zLmNoayA9PSBudWxsKVxuXHR7XG5cdFx0cmV0ID0gY2hrSW5mbyhyZXQsIG9wdGlvbnMpO1xuXHR9XG5cblx0aWYgKG9wdGlvbnMudGhyb3cgfHwgb3B0aW9ucy50aHJvdyA9PSBudWxsKVxuXHR7XG5cdFx0cmV0ID0gY2hrSW5mbyhyZXQsIG9wdGlvbnMpO1xuXG5cdFx0aWYgKCFyZXQpXG5cdFx0e1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdtZGNvbmZfcGFyc2UnKTtcblx0XHR9XG5cdH1cblxuXHRpZiAocmV0KVxuXHR7XG5cdFx0cmV0ID0gc29ydEtleXMocmV0KTtcblxuXHRcdC8vY29uc29sZS5sb2coNzc3KTtcblx0fVxuXG5cdHJldHVybiByZXQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzb3J0S2V5cyhyZXQ6IElNZGNvbmZNZXRhKVxue1xuXHRyZXQgPSBzb3J0T2JqZWN0S2V5cyhyZXQsIFtcblx0XHQnbm92ZWwnLFxuXHRcdCdjb250cmlidXRlJyxcblx0XHQnb3B0aW9ucycsXG5cdF0pO1xuXG5cdHNvcnRTdWJLZXkoJ25vdmVsJywgW1xuXHRcdCd0aXRsZScsXG5cdFx0J3RpdGxlX3Nob3J0Jyxcblx0XHQndGl0bGVfemgnLFxuXHRcdCd0aXRsZV9lbicsXG5cdFx0J3RpdGxlX2pwJyxcblx0XHQnYXV0aG9yJyxcblx0XHQnc291cmNlJyxcblx0XHQnY292ZXInLFxuXHRcdCdwdWJsaXNoZXInLFxuXHRcdCdkYXRlJyxcblx0XHQnc3RhdHVzJyxcblx0XHQncjE4JyxcblxuXHRcdCdzZXJpZXMnLFxuXG5cdFx0J3ByZWZhY2UnLFxuXHRcdCd0YWdzJyxcblx0XSk7XG5cblx0c29ydFN1YktleShbJ25vdmVsJywgJ3RhZ3MnXSwgbnVsbCwgdHJ1ZSk7XG5cdHNvcnRTdWJLZXkoJ2NvbnRyaWJ1dGUnLCBudWxsLCB0cnVlKTtcblx0c29ydFN1YktleSgnb3B0aW9ucycpO1xuXG5cdGZ1bmN0aW9uIHNvcnRTdWJLZXkoa2V5LCBzb3J0TGlzdD86IHN0cmluZ1tdLCB1bmlxdWU/OiBib29sZWFuKVxuXHR7XG5cdFx0bGV0IG9iaiA9IHJldDtcblx0XHRsZXQgcGFyZW50ID0gb2JqO1xuXG5cdFx0Ly9jb25zb2xlLmxvZyhvYmosIHNvcnRMaXN0KTtcblxuXHRcdGlmIChBcnJheS5pc0FycmF5KGtleSkpXG5cdFx0e1xuXHRcdFx0Ly9jb25zb2xlLmxvZyhrZXkpO1xuXG5cdFx0XHRsZXQgX2s7XG5cblx0XHRcdGZvciAobGV0IHZhbHVlIG9mIGtleSlcblx0XHRcdHtcblx0XHRcdFx0aWYgKCEodmFsdWUgaW4gb2JqKSlcblx0XHRcdFx0e1xuXHRcdFx0XHRcdC8vY29uc29sZS5sb2codmFsdWUsIHBhcmVudCk7XG5cblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRfayA9IHZhbHVlO1xuXG5cdFx0XHRcdHBhcmVudCA9IG9iajtcblx0XHRcdFx0b2JqID0gcGFyZW50W3ZhbHVlXTtcblx0XHRcdH1cblxuXHRcdFx0a2V5ID0gX2s7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKChrZXkgaW4gcGFyZW50KSlcblx0XHR7XG5cdFx0XHRvYmogPSBwYXJlbnRba2V5XTtcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRpZiAoQXJyYXkuaXNBcnJheShvYmopKVxuXHRcdHtcblx0XHRcdG9iai5zb3J0KCk7XG5cdFx0XHRwYXJlbnRba2V5XSA9IG9iajtcblx0XHRcdGlmICh1bmlxdWUpXG5cdFx0XHR7XG5cdFx0XHRcdHBhcmVudFtrZXldID0gcGFyZW50W2tleV0uZmlsdGVyKGZ1bmN0aW9uICh2KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmV0dXJuIHY7XG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdHBhcmVudFtrZXldID0gYXJyYXlfdW5pcXVlKHBhcmVudFtrZXldKTtcblxuXHRcdFx0XHRpZiAocGFyZW50W2tleV0ubGVuZ3RoID09IDEgJiYgKHBhcmVudFtrZXldWzBdID09PSBudWxsIHx8IHR5cGVvZiBwYXJlbnRba2V5XVswXSA9PSAndW5kZWZpbmVkJykpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRwYXJlbnRba2V5XSA9IFtdO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0aWYgKGlzUGxhaW5PYmplY3Qob2JqKSlcblx0XHR7XG5cdFx0XHRwYXJlbnRba2V5XSA9IHNvcnRPYmplY3RLZXlzKG9iaiwgc29ydExpc3QpO1xuXHRcdH1cblx0fVxuXG5cdHJldHVybiByZXQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjaGtJbmZvKHJldDogSU1kY29uZk1ldGEsIG9wdGlvbnM6IElPcHRpb25zUGFyc2UgPSB7fSk6IElNZGNvbmZNZXRhXG57XG5cdGlmICghcmV0XG5cdFx0fHwgKFxuXHRcdFx0KCFvcHRpb25zIHx8ICFvcHRpb25zLmxvd0NoZWNrTGV2ZWwpXG5cdFx0XHQmJiAoIXJldC5ub3ZlbCB8fCAhcmV0Lm5vdmVsLnRpdGxlKVxuXHRcdClcblx0KVxuXHR7XG5cdFx0cmV0dXJuIG51bGw7XG5cdH1cblxuXHRpZiAocmV0Lm5vdmVsKVxuXHR7XG5cdFx0W1xuXHRcdFx0J2F1dGhvcnMnLFxuXHRcdFx0J2lsbHVzdCcsXG5cdFx0XHQndGFncycsXG5cdFx0XHQnc291cmNlcycsXG5cdFx0XS5mb3JFYWNoKGsgPT4ge1xuXHRcdFx0aWYgKGsgaW4gcmV0Lm5vdmVsKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXQubm92ZWxba10gPSBhbnlUb0FycmF5KHJldC5ub3ZlbFtrXSwgdHJ1ZSk7XG5cdFx0XHR9XG5cdFx0fSlcblx0fVxuXG5cdGlmICgnY29udHJpYnV0ZScgaW4gcmV0KVxuXHR7XG5cdFx0cmV0LmNvbnRyaWJ1dGUgPSBhbnlUb0FycmF5KHJldC5jb250cmlidXRlLCB0cnVlKTtcblx0fVxuXG5cdHJldC5vcHRpb25zID0gcmV0Lm9wdGlvbnMgfHwge307XG5cblx0aWYgKHR5cGVvZiByZXQub3B0aW9ucy50ZXh0bGF5b3V0ID09PSAnb2JqZWN0Jylcblx0e1xuXHRcdE9iamVjdC5lbnRyaWVzKHJldC5vcHRpb25zLnRleHRsYXlvdXQpXG5cdFx0XHQuZm9yRWFjaCgoW2ssIHZdKSA9PiByZXQub3B0aW9ucy50ZXh0bGF5b3V0W2tdID0gZW52VmFsKHYpKVxuXHRcdDtcblx0fVxuXG5cdGlmICh0eXBlb2YgcmV0Lm9wdGlvbnMuZG93bmxvYWRvcHRpb25zID09PSAnb2JqZWN0Jylcblx0e1xuXHRcdE9iamVjdC5lbnRyaWVzKHJldC5vcHRpb25zLmRvd25sb2Fkb3B0aW9ucylcblx0XHRcdC5mb3JFYWNoKChbaywgdl0pID0+IHJldC5vcHRpb25zLmRvd25sb2Fkb3B0aW9uc1trXSA9IGVudlZhbCh2KSlcblx0XHQ7XG5cdH1cblxuXHRyZXR1cm4gcmV0O1xufVxuXG5mdW5jdGlvbiBhbnlUb0FycmF5PFQgPSBzdHJpbmc+KGlucHV0OiBUIHwgVFtdLCB1bmlxdWU/OiBib29sZWFuKTogVFtdXG57XG5cdGlmICh0eXBlb2YgaW5wdXQgIT0gJ29iamVjdCcpXG5cdHtcblx0XHRpbnB1dCA9IFtpbnB1dF07XG5cdH1cblxuXHRpZiAodW5pcXVlKVxuXHR7XG5cdFx0aW5wdXQgPSBhcnJheV91bmlxdWUoaW5wdXQgfHwgW10pO1xuXHR9XG5cblx0Ly8gQHRzLWlnbm9yZVxuXHRyZXR1cm4gaW5wdXQ7XG59XG5cbmV4cG9ydCBjb25zdCB2ZXJzaW9uOiBzdHJpbmcgPSByZXF1aXJlKFwiLi9wYWNrYWdlLmpzb25cIikudmVyc2lvbjtcblxuaW1wb3J0ICogYXMgc2VsZiBmcm9tICcuL2luZGV4JztcblxuZXhwb3J0IGltcG9ydCBtZGNvbmZfcGFyc2UgPSBzZWxmLnBhcnNlO1xuXG5leHBvcnQgZGVmYXVsdCBzZWxmO1xuIl19