"use strict";
/**
 * Created by user on 2018/1/27/027.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const mdconf = require("mdconf2");
exports.mdconf = mdconf;
const crlf_normalize_1 = require("crlf-normalize");
exports.crlf = crlf_normalize_1.crlf;
exports.LF = crlf_normalize_1.LF;
const lib_1 = require("./lib");
exports.array_unique = lib_1.array_unique;
exports.deepmerge = lib_1.deepmerge;
exports.deepmergeOptions = lib_1.deepmergeOptions;
const isPlainObject = require("is-plain-object");
const sortObjectKeys = require("sort-object-keys2");
const json_1 = require("./json");
const env_bool_1 = require("env-bool");
exports.envVal = env_bool_1.envVal;
exports.envBool = env_bool_1.envBool;
const hex_lib_1 = require("hex-lib");
const chai_1 = require("chai");
exports.defaultOptionsParse = {
    removeRawData: true,
    disableKeyToLowerCase: true,
};
function stringify(data, d2, ...argv) {
    data = json_1.default.toNovelInfo(data, d2 || {}, {
        novel: {
            tags: [],
        },
    }, ...argv);
    data = sortKeys(data);
    data.novel.tags.unshift('node-novel');
    data.novel.tags = lib_1.array_unique(data.novel.tags);
    if (data.novel.preface && typeof data.novel.preface == 'string') {
        data.novel.preface = new mdconf.RawObject(data.novel.preface, {});
    }
    if ('novel_status' in data.novel) {
        chai_1.expect(data.novel.novel_status).a('number');
        data.novel.novel_status = hex_lib_1.toHex(data.novel.novel_status, 4);
    }
    return mdconf.stringify(data) + crlf_normalize_1.LF.repeat(2);
}
exports.stringify = stringify;
function parse(data, options = {}) {
    if (options.removeRawData) {
        options.oldParseApi = options.removeRawData;
    }
    if (options.disableKeyToLowerCase == null) {
        options.disableKeyToLowerCase = true;
    }
    let ret = mdconf.parse(crlf_normalize_1.crlf(data.toString()), options);
    try {
        if (ret.novel.preface) {
            ret.novel.preface = (ret.novel.preface
                && ret.novel.preface.length
                && Array.isArray(ret.novel.preface)) ? ret.novel.preface.join(crlf_normalize_1.LF) : ret.novel.preface;
        }
        ret.options = lib_1.deepmerge(ret.options || {}, {
            textlayout: {},
        }, lib_1.deepmergeOptions);
    }
    catch (e) {
        console.error(e.toString());
    }
    if (options.chk || options.chk == null) {
        ret = chkInfo(ret, options);
    }
    if (options.throw || options.throw == null) {
        ret = chkInfo(ret, options);
        if (!ret) {
            throw new Error('mdconf_parse');
        }
    }
    if (ret) {
        ret = sortKeys(ret);
        //console.log(777);
    }
    // @ts-ignore
    return ret;
}
exports.parse = parse;
function sortKeys(ret) {
    ret = sortObjectKeys(ret, [
        'novel',
        'contribute',
        'options',
    ]);
    sortSubKey('novel', [
        'title',
        'title_short',
        'title_zh',
        'title_zh1',
        'title_zh2',
        'title_en',
        'title_jp',
        'title_output',
        'title_other',
        'author',
        'source',
        'cover',
        'publisher',
        'date',
        'status',
        'novel_status',
        'r18',
        'series',
        'preface',
        'tags',
    ]);
    sortSubKey(['novel', 'tags'], null, true);
    sortSubKey('contribute', null, true);
    sortSubKey('options');
    function sortSubKey(key, sortList, unique) {
        let obj = ret;
        let parent = obj;
        //console.log(obj, sortList);
        if (Array.isArray(key)) {
            //console.log(key);
            let _k;
            for (let value of key) {
                if (!(value in obj)) {
                    //console.log(value, parent);
                    return;
                }
                _k = value;
                parent = obj;
                obj = parent[value];
            }
            key = _k;
        }
        else if ((key in parent)) {
            obj = parent[key];
        }
        else {
            return;
        }
        if (Array.isArray(obj)) {
            obj.sort();
            parent[key] = obj;
            if (unique) {
                parent[key] = parent[key].filter(function (v) {
                    return v;
                });
                parent[key] = lib_1.array_unique(parent[key]);
                if (parent[key].length == 1 && (parent[key][0] === null || typeof parent[key][0] == 'undefined')) {
                    parent[key] = [];
                }
            }
            return;
        }
        if (isPlainObject(obj)) {
            parent[key] = sortObjectKeys(obj, sortList);
        }
    }
    return ret;
}
exports.sortKeys = sortKeys;
function chkInfo(ret, options = {}) {
    if (!ret
        || ((!options || !options.lowCheckLevel)
            && (!ret.novel || !ret.novel.title))) {
        return null;
    }
    if (ret.novel) {
        [
            'authors',
            'illusts',
            'tags',
            'sources',
            'publishers',
        ].forEach(k => {
            if (k in ret.novel) {
                ret.novel[k] = anyToArray(ret.novel[k], true);
            }
        });
        if ('novel_status' in ret.novel) {
            ret.novel.novel_status = env_bool_1.envVal(ret.novel.novel_status);
            if (typeof ret.novel.novel_status === 'string' && /^0x[\da-f]+$/.test(ret.novel.novel_status)) {
                ret.novel.novel_status = Number(ret.novel.novel_status);
            }
        }
    }
    if ('contribute' in ret) {
        ret.contribute = anyToArray(ret.contribute, true);
    }
    ret.options = ret.options || {};
    if (typeof ret.options.textlayout === 'object') {
        Object.entries(ret.options.textlayout)
            .forEach(([k, v]) => ret.options.textlayout[k] = env_bool_1.envVal(v));
    }
    if (typeof ret.options.downloadOptions === 'object') {
        Object.entries(ret.options.downloadOptions)
            .forEach(([k, v]) => ret.options.downloadOptions[k] = env_bool_1.envVal(v));
    }
    return ret;
}
exports.chkInfo = chkInfo;
function getNovelTitleFromMeta(meta) {
    if (meta && meta.novel) {
        let arr = [
            'title',
            'title_source',
            'title_jp',
            'title_ja',
            'title_zh',
            'title_tw',
            'title_cn',
        ].concat(Object.keys(meta.novel))
            .reduce(function (a, key) {
            if (key.indexOf('title') === 0) {
                a.push(meta.novel[key]);
            }
            return a;
        }, []);
        if (meta.novel.series) {
            arr.push(meta.novel.series.name);
            arr.push(meta.novel.series.name_short);
        }
        arr = lib_1.array_unique(arr.filter(v => v && ![
            'undefined',
            '長編 【連載】',
            '連載中',
        ].includes(v)));
        return arr;
    }
    return [];
}
exports.getNovelTitleFromMeta = getNovelTitleFromMeta;
function anyToArray(input, unique) {
    if (typeof input != 'object') {
        input = [input];
    }
    if (unique) {
        input = lib_1.array_unique(input || []);
    }
    // @ts-ignore
    return input;
}
exports.version = require("./package.json").version;
exports.mdconf_parse = parse;
exports.default = exports;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBR0gsa0NBQWtDO0FBV3pCLHdCQUFNO0FBVmYsbURBQTBDO0FBVVgsZUFWdEIscUJBQUksQ0FVc0I7QUFBRSxhQVZ0QixtQkFBRSxDQVVzQjtBQVR2QywrQkFBa0U7QUFTakQsdUJBVFIsa0JBQVksQ0FTUTtBQUNwQixvQkFWYyxlQUFTLENBVWQ7QUFBRSwyQkFWYyxzQkFBZ0IsQ0FVZDtBQVJwQyxpREFBaUQ7QUFDakQsb0RBQW9EO0FBQ3BELGlDQUE0QjtBQUM1Qix1Q0FBMkM7QUFNbEMsaUJBTkEsaUJBQU0sQ0FNQTtBQUFFLGtCQU5BLGtCQUFPLENBTUE7QUFMeEIscUNBQWdDO0FBQ2hDLCtCQUE4QjtBQTZJakIsUUFBQSxtQkFBbUIsR0FBa0I7SUFDakQsYUFBYSxFQUFFLElBQUk7SUFDbkIscUJBQXFCLEVBQUUsSUFBSTtDQUMzQixDQUFDO0FBRUYsU0FBZ0IsU0FBUyxDQUFDLElBQUksRUFBRSxFQUFHLEVBQUUsR0FBRyxJQUFJO0lBRTNDLElBQUksR0FBRyxjQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxFQUFFO1FBQ3pDLEtBQUssRUFBRTtZQUNOLElBQUksRUFBRSxFQUFFO1NBQ1I7S0FDRCxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFFWixJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUN0QyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxrQkFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFaEQsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sSUFBSSxPQUFPLElBQUksQ0FBQyxL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WyIvKipcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyMDE4LzEvMjcvMDI3LlxuICovXG5cbmltcG9ydCB7IEVudW1Ob3ZlbFN0YXR1cyB9IGZyb20gJy4vbGliL2NvbnN0JztcbmltcG9ydCAqIGFzIG1kY29uZiBmcm9tICdtZGNvbmYyJztcbmltcG9ydCB7IGNybGYsIExGIH0gZnJvbSAnY3JsZi1ub3JtYWxpemUnO1xuaW1wb3J0IHsgYXJyYXlfdW5pcXVlLCBkZWVwbWVyZ2UsIGRlZXBtZXJnZU9wdGlvbnMgfSBmcm9tICcuL2xpYic7XG5pbXBvcnQgKiBhcyBtb21lbnQgZnJvbSAnbW9tZW50JztcbmltcG9ydCAqIGFzIGlzUGxhaW5PYmplY3QgZnJvbSAnaXMtcGxhaW4tb2JqZWN0JztcbmltcG9ydCAqIGFzIHNvcnRPYmplY3RLZXlzIGZyb20gJ3NvcnQtb2JqZWN0LWtleXMyJztcbmltcG9ydCBKc29uTWQgZnJvbSAnLi9qc29uJztcbmltcG9ydCB7IGVudlZhbCwgZW52Qm9vbCB9IGZyb20gJ2Vudi1ib29sJztcbmltcG9ydCB7IHRvSGV4IH0gZnJvbSAnaGV4LWxpYic7XG5pbXBvcnQgeyBleHBlY3QgfSBmcm9tICdjaGFpJztcblxuZXhwb3J0IHsgbWRjb25mLCBhcnJheV91bmlxdWUsIGNybGYsIExGIH1cbmV4cG9ydCB7IGRlZXBtZXJnZSwgZGVlcG1lcmdlT3B0aW9ucyB9XG5leHBvcnQgeyBlbnZWYWwsIGVudkJvb2wgfVxuXG5leHBvcnQgdHlwZSBJTnVtYmVyID0gbnVtYmVyIHwgc3RyaW5nO1xuXG5leHBvcnQgaW50ZXJmYWNlIElNZGNvbmZNZXRhT3B0aW9uc0Jhc2U8VCA9IGFueT5cbntcblx0W2tleTogc3RyaW5nXTogVCxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJTWRjb25mTWV0YU9wdGlvbnNOb3ZlbFNpdGUgZXh0ZW5kcyBJTWRjb25mTWV0YU9wdGlvbnNCYXNlXG57XG5cdG5vdmVsX2lkPzogSU51bWJlcixcblx0dXJsPzogc3RyaW5nLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElNZGNvbmZNZXRhXG57XG5cdG5vdmVsPzoge1xuXHRcdHRpdGxlPzogc3RyaW5nLFxuXG5cdFx0LyoqXG5cdFx0ICog5Y6f5aeL5qiZ6aGMXG5cdFx0ICovXG5cdFx0dGl0bGVfc291cmNlPzogc3RyaW5nLFxuXG5cdFx0LyoqXG5cdFx0ICog57Ch55+t5qiZ6aGMXG5cdFx0ICog5aaC5p6cIHRpdGxlX291dHB1dCDkuI3lrZjlnKgg6YCZ5YCL5YmH5pyD5L2c54K66Ly45Ye6IGVwdWIg55qE5qqU5ZCN5YKZ6YG45LmL5LiAXG5cdFx0ICovXG5cdFx0dGl0bGVfc2hvcnQ/OiBzdHJpbmcsXG5cdFx0LyoqXG5cdFx0ICog6Ly45Ye6IGVwdWIg55qE5qqU5ZCNXG5cdFx0ICovXG5cdFx0dGl0bGVfb3V0cHV0Pzogc3RyaW5nLFxuXG5cdFx0dGl0bGVfb3RoZXI/OiBzdHJpbmcsXG5cblx0XHR0aXRsZV96aDE/OiBzdHJpbmcsXG5cdFx0dGl0bGVfemgyPzogc3RyaW5nLFxuXG5cdFx0dGl0bGVfemg/OiBzdHJpbmcsXG5cdFx0dGl0bGVfY24/OiBzdHJpbmcsXG5cdFx0dGl0bGVfdHc/OiBzdHJpbmcsXG5cdFx0dGl0bGVfZW4/OiBzdHJpbmcsXG5cdFx0dGl0bGVfanA/OiBzdHJpbmcsXG5cblx0XHRhdXRob3I/OiBzdHJpbmcsXG5cdFx0YXV0aG9ycz86IHN0cmluZ1tdLFxuXG5cdFx0LyoqXG5cdFx0ICog5bCB6Z2i5ZyWXG5cdFx0ICovXG5cdFx0Y292ZXI/OiBzdHJpbmcsXG5cdFx0LyoqXG5cdFx0ICog57mq5birXG5cdFx0ICovXG5cdFx0aWxsdXN0Pzogc3RyaW5nLFxuXHRcdGlsbHVzdHM/OiBzdHJpbmdbXSxcblxuXHRcdC8qKlxuXHRcdCAqIOewoeS7i1xuXHRcdCAqL1xuXHRcdHByZWZhY2U/OiBzdHJpbmcsXG5cdFx0dGFncz86IHN0cmluZ1tdLFxuXHRcdGRhdGU/OiBzdHJpbmcsXG5cdFx0c3RhdHVzPzogc3RyaW5nLFxuXHRcdHIxOD86IHN0cmluZyxcblxuXHRcdHNlcmllcz86IHtcblx0XHRcdG5hbWU/OiBzdHJpbmcsXG5cdFx0XHRuYW1lX3Nob3J0Pzogc3RyaW5nLFxuXHRcdFx0cG9zaXRpb24/OiBudW1iZXIsXG5cdFx0fSxcblxuXHRcdHNvdXJjZT86IHN0cmluZyxcblx0XHRzb3VyY2VzPzogc3RyaW5nW10sXG5cblx0XHRwdWJsaXNoZXI/OiBzdHJpbmcsXG5cdFx0cHVibGlzaGVycz86IHN0cmluZ1tdLFxuXG5cdFx0LyoqXG5cdFx0ICog5bCP6Kqq54uA5oWLIGZsYWdcblx0XHQgKi9cblx0XHRub3ZlbF9zdGF0dXM/OiBFbnVtTm92ZWxTdGF0dXMgfCBudW1iZXIsXG5cdH1cblxuXHQvKipcblx0ICog57+76K2vIOagoeWwjSDmlbTlkIggLi4u562JIOiyoueNu+iAhSDmiJYg5YW25LuWXG5cdCAqL1xuXHRjb250cmlidXRlPzogc3RyaW5nW10sXG5cblx0b3B0aW9ucz86IElNZGNvbmZNZXRhT3B0aW9uc0Jhc2UgJiB7XG5cblx0XHRkbXpqPzogSU1kY29uZk1ldGFPcHRpb25zTm92ZWxTaXRlLFxuXHRcdGtha3V5b211PzogSU1kY29uZk1ldGFPcHRpb25zTm92ZWxTaXRlLFxuXHRcdHdlbmt1OD86IElNZGNvbmZNZXRhT3B0aW9uc05vdmVsU2l0ZSxcblx0XHR3ZWJxeHM/OiBJTWRjb25mTWV0YU9wdGlvbnNOb3ZlbFNpdGUsXG5cdFx0c3lvc2V0dT86IElNZGNvbmZNZXRhT3B0aW9uc05vdmVsU2l0ZSAmIHtcblx0XHRcdHR4dGRvd25sb2FkX2lkOiBJTnVtYmVyLFxuXHRcdH0sXG5cblx0XHRub3ZlbD86IElNZGNvbmZNZXRhT3B0aW9uc0Jhc2UgJiB7XG5cdFx0XHRwYXR0ZXJuPzogc3RyaW5nLFxuXHRcdH0sXG5cblx0XHR0ZXh0bGF5b3V0PzogSU1kY29uZk1ldGFPcHRpb25zQmFzZSAmIHtcblx0XHRcdGFsbG93X2xmMj86IGJvb2xlYW4sXG5cdFx0XHRhbGxvd19sZjM/OiBib29sZWFuLFxuXHRcdH0sXG5cblx0XHQvKipcblx0XHQgKiBub3ZlbC1kb3dubG9hZGVyXG5cdFx0ICovXG5cdFx0ZG93bmxvYWRPcHRpb25zPzogSU1kY29uZk1ldGFPcHRpb25zQmFzZSAmIHtcblx0XHRcdG5vRmlyZVByZWZpeD86IGJvb2xlYW4sXG5cdFx0XHRub0ZpbGVQYWRlbmQ/OiBib29sZWFuLFxuXHRcdFx0ZmlsZVByZWZpeE1vZGU/OiBudW1iZXIsXG5cdFx0XHRzdGFydEluZGV4PzogbnVtYmVyLFxuXHRcdH0sXG5cblx0fSxcblxuXHRsaW5rPzogc3RyaW5nW10sXG59XG5cbmV4cG9ydCB0eXBlIElPcHRpb25zUGFyc2UgPSBtZGNvbmYuSU9wdGlvbnNQYXJzZSAmIHtcblx0Y2hrPzogYm9vbGVhbixcblx0dGhyb3c/OiBib29sZWFuLFxuXG5cdHJlbW92ZVJhd0RhdGE/OiBib29sZWFuLFxuXG5cdC8qKlxuXHQgKiDlhYHoqLHmrpjnvLrkuI3lkIjms5XnmoQgbWV0YSBpbmZvXG5cdCAqL1xuXHRsb3dDaGVja0xldmVsPzogYm9vbGVhbixcbn1cblxuZXhwb3J0IGNvbnN0IGRlZmF1bHRPcHRpb25zUGFyc2U6IElPcHRpb25zUGFyc2UgPSB7XG5cdHJlbW92ZVJhd0RhdGE6IHRydWUsXG5cdGRpc2FibGVLZXlUb0xvd2VyQ2FzZTogdHJ1ZSxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBzdHJpbmdpZnkoZGF0YSwgZDI/LCAuLi5hcmd2KTogc3RyaW5nXG57XG5cdGRhdGEgPSBKc29uTWQudG9Ob3ZlbEluZm8oZGF0YSwgZDIgfHwge30sIHtcblx0XHRub3ZlbDoge1xuXHRcdFx0dGFnczogW10sXG5cdFx0fSxcblx0fSwgLi4uYXJndik7XG5cblx0ZGF0YSA9IHNvcnRLZXlzKGRhdGEpO1xuXHRkYXRhLm5vdmVsLnRhZ3MudW5zaGlmdCgnbm9kZS1ub3ZlbCcpO1xuXHRkYXRhLm5vdmVsLnRhZ3MgPSBhcnJheV91bmlxdWUoZGF0YS5ub3ZlbC50YWdzKTtcblxuXHRpZiAoZGF0YS5ub3ZlbC5wcmVmYWNlICYmIHR5cGVvZiBkYXRhLm5vdmVsLnByZWZhY2UgPT0gJ3N0cmluZycpXG5cdHtcblx0XHRkYXRhLm5vdmVsLnByZWZhY2UgPSBuZXcgbWRjb25mLlJhd09iamVjdChkYXRhLm5vdmVsLnByZWZhY2UsIHt9KTtcblx0fVxuXG5cdGlmICgnbm92ZWxfc3RhdHVzJyBpbiBkYXRhLm5vdmVsKVxuXHR7XG5cdFx0ZXhwZWN0KGRhdGEubm92ZWwubm92ZWxfc3RhdHVzKS5hKCdudW1iZXInKTtcblxuXHRcdGRhdGEubm92ZWwubm92ZWxfc3RhdHVzID0gdG9IZXgoZGF0YS5ub3ZlbC5ub3ZlbF9zdGF0dXMsIDQpO1xuXHR9XG5cblx0cmV0dXJuIG1kY29uZi5zdHJpbmdpZnkoZGF0YSkgKyBMRi5yZXBlYXQoMik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZTxUID0gSU1kY29uZk1ldGE+KGRhdGE6IHtcblx0dG9TdHJpbmcoKTogc3RyaW5nLFxufSwgb3B0aW9ucz86IElPcHRpb25zUGFyc2UpOiBUXG5leHBvcnQgZnVuY3Rpb24gcGFyc2U8VCA9IElNZGNvbmZNZXRhPihkYXRhOiBzdHJpbmcsIG9wdGlvbnM/OiBJT3B0aW9uc1BhcnNlKTogVFxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlPFQgZXh0ZW5kcyBJTWRjb25mTWV0YT4oZGF0YSwgb3B0aW9uczogSU9wdGlvbnNQYXJzZSA9IHt9KTogVFxue1xuXHRpZiAob3B0aW9ucy5yZW1vdmVSYXdEYXRhKVxuXHR7XG5cdFx0b3B0aW9ucy5vbGRQYXJzZUFwaSA9IG9wdGlvbnMucmVtb3ZlUmF3RGF0YTtcblx0fVxuXG5cdGlmIChvcHRpb25zLmRpc2FibGVLZXlUb0xvd2VyQ2FzZSA9PSBudWxsKVxuXHR7XG5cdFx0b3B0aW9ucy5kaXNhYmxlS2V5VG9Mb3dlckNhc2UgPSB0cnVlO1xuXHR9XG5cblx0bGV0IHJldCA9IG1kY29uZi5wYXJzZShjcmxmKGRhdGEudG9TdHJpbmcoKSksIG9wdGlvbnMpIGFzIElNZGNvbmZNZXRhO1xuXG5cdHRyeVxuXHR7XG5cdFx0aWYgKHJldC5ub3ZlbC5wcmVmYWNlKVxuXHRcdHtcblx0XHRcdHJldC5ub3ZlbC5wcmVmYWNlID0gKHJldC5ub3ZlbC5wcmVmYWNlXG5cdFx0XHRcdCYmIHJldC5ub3ZlbC5wcmVmYWNlLmxlbmd0aFxuXHRcdFx0XHQmJiBBcnJheS5pc0FycmF5KHJldC5ub3ZlbC5wcmVmYWNlKSkgPyByZXQubm92ZWwucHJlZmFjZS5qb2luKExGKSA6IHJldC5ub3ZlbC5wcmVmYWNlXG5cdFx0XHQ7XG5cdFx0fVxuXG5cdFx0cmV0Lm9wdGlvbnMgPSBkZWVwbWVyZ2UocmV0Lm9wdGlvbnMgfHwge30sIHtcblxuXHRcdFx0dGV4dGxheW91dDoge30sXG5cblx0XHR9LCBkZWVwbWVyZ2VPcHRpb25zKTtcblx0fVxuXHRjYXRjaCAoZSlcblx0e1xuXHRcdGNvbnNvbGUuZXJyb3IoZS50b1N0cmluZygpKTtcblx0fVxuXG5cdGlmIChvcHRpb25zLmNoayB8fCBvcHRpb25zLmNoayA9PSBudWxsKVxuXHR7XG5cdFx0cmV0ID0gY2hrSW5mbyhyZXQsIG9wdGlvbnMpO1xuXHR9XG5cblx0aWYgKG9wdGlvbnMudGhyb3cgfHwgb3B0aW9ucy50aHJvdyA9PSBudWxsKVxuXHR7XG5cdFx0cmV0ID0gY2hrSW5mbyhyZXQsIG9wdGlvbnMpO1xuXG5cdFx0aWYgKCFyZXQpXG5cdFx0e1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdtZGNvbmZfcGFyc2UnKTtcblx0XHR9XG5cdH1cblxuXHRpZiAocmV0KVxuXHR7XG5cdFx0cmV0ID0gc29ydEtleXMocmV0KTtcblxuXHRcdC8vY29uc29sZS5sb2coNzc3KTtcblx0fVxuXG5cdC8vIEB0cy1pZ25vcmVcblx0cmV0dXJuIHJldDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNvcnRLZXlzKHJldDogSU1kY29uZk1ldGEpXG57XG5cdHJldCA9IHNvcnRPYmplY3RLZXlzKHJldCwgW1xuXHRcdCdub3ZlbCcsXG5cdFx0J2NvbnRyaWJ1dGUnLFxuXHRcdCdvcHRpb25zJyxcblx0XSk7XG5cblx0c29ydFN1YktleSgnbm92ZWwnLCBbXG5cdFx0J3RpdGxlJyxcblx0XHQndGl0bGVfc2hvcnQnLFxuXHRcdCd0aXRsZV96aCcsXG5cdFx0J3RpdGxlX3poMScsXG5cdFx0J3RpdGxlX3poMicsXG5cdFx0J3RpdGxlX2VuJyxcblx0XHQndGl0bGVfanAnLFxuXHRcdCd0aXRsZV9vdXRwdXQnLFxuXHRcdCd0aXRsZV9vdGhlcicsXG5cdFx0J2F1dGhvcicsXG5cdFx0J3NvdXJjZScsXG5cdFx0J2NvdmVyJyxcblx0XHQncHVibGlzaGVyJyxcblx0XHQnZGF0ZScsXG5cdFx0J3N0YXR1cycsXG5cdFx0J25vdmVsX3N0YXR1cycsXG5cdFx0J3IxOCcsXG5cblx0XHQnc2VyaWVzJyxcblxuXHRcdCdwcmVmYWNlJyxcblx0XHQndGFncycsXG5cdF0pO1xuXG5cdHNvcnRTdWJLZXkoWydub3ZlbCcsICd0YWdzJ10sIG51bGwsIHRydWUpO1xuXHRzb3J0U3ViS2V5KCdjb250cmlidXRlJywgbnVsbCwgdHJ1ZSk7XG5cdHNvcnRTdWJLZXkoJ29wdGlvbnMnKTtcblxuXHRmdW5jdGlvbiBzb3J0U3ViS2V5KGtleSwgc29ydExpc3Q/OiBzdHJpbmdbXSwgdW5pcXVlPzogYm9vbGVhbilcblx0e1xuXHRcdGxldCBvYmogPSByZXQ7XG5cdFx0bGV0IHBhcmVudCA9IG9iajtcblxuXHRcdC8vY29uc29sZS5sb2cob2JqLCBzb3J0TGlzdCk7XG5cblx0XHRpZiAoQXJyYXkuaXNBcnJheShrZXkpKVxuXHRcdHtcblx0XHRcdC8vY29uc29sZS5sb2coa2V5KTtcblxuXHRcdFx0bGV0IF9rO1xuXG5cdFx0XHRmb3IgKGxldCB2YWx1ZSBvZiBrZXkpXG5cdFx0XHR7XG5cdFx0XHRcdGlmICghKHZhbHVlIGluIG9iaikpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHQvL2NvbnNvbGUubG9nKHZhbHVlLCBwYXJlbnQpO1xuXG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0X2sgPSB2YWx1ZTtcblxuXHRcdFx0XHRwYXJlbnQgPSBvYmo7XG5cdFx0XHRcdG9iaiA9IHBhcmVudFt2YWx1ZV07XG5cdFx0XHR9XG5cblx0XHRcdGtleSA9IF9rO1xuXHRcdH1cblx0XHRlbHNlIGlmICgoa2V5IGluIHBhcmVudCkpXG5cdFx0e1xuXHRcdFx0b2JqID0gcGFyZW50W2tleV07XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0aWYgKEFycmF5LmlzQXJyYXkob2JqKSlcblx0XHR7XG5cdFx0XHRvYmouc29ydCgpO1xuXHRcdFx0cGFyZW50W2tleV0gPSBvYmo7XG5cdFx0XHRpZiAodW5pcXVlKVxuXHRcdFx0e1xuXHRcdFx0XHRwYXJlbnRba2V5XSA9IHBhcmVudFtrZXldLmZpbHRlcihmdW5jdGlvbiAodilcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHJldHVybiB2O1xuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRwYXJlbnRba2V5XSA9IGFycmF5X3VuaXF1ZShwYXJlbnRba2V5XSk7XG5cblx0XHRcdFx0aWYgKHBhcmVudFtrZXldLmxlbmd0aCA9PSAxICYmIChwYXJlbnRba2V5XVswXSA9PT0gbnVsbCB8fCB0eXBlb2YgcGFyZW50W2tleV1bMF0gPT0gJ3VuZGVmaW5lZCcpKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cGFyZW50W2tleV0gPSBbXTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdGlmIChpc1BsYWluT2JqZWN0KG9iaikpXG5cdFx0e1xuXHRcdFx0cGFyZW50W2tleV0gPSBzb3J0T2JqZWN0S2V5cyhvYmosIHNvcnRMaXN0KTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gcmV0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2hrSW5mbyhyZXQ6IElNZGNvbmZNZXRhLCBvcHRpb25zOiBJT3B0aW9uc1BhcnNlID0ge30pOiBJTWRjb25mTWV0YVxue1xuXHRpZiAoIXJldFxuXHRcdHx8IChcblx0XHRcdCghb3B0aW9ucyB8fCAhb3B0aW9ucy5sb3dDaGVja0xldmVsKVxuXHRcdFx0JiYgKCFyZXQubm92ZWwgfHwgIXJldC5ub3ZlbC50aXRsZSlcblx0XHQpXG5cdClcblx0e1xuXHRcdHJldHVybiBudWxsO1xuXHR9XG5cblx0aWYgKHJldC5ub3ZlbClcblx0e1xuXHRcdFtcblx0XHRcdCdhdXRob3JzJyxcblx0XHRcdCdpbGx1c3RzJyxcblx0XHRcdCd0YWdzJyxcblx0XHRcdCdzb3VyY2VzJyxcblx0XHRcdCdwdWJsaXNoZXJzJyxcblx0XHRdLmZvckVhY2goayA9PiB7XG5cdFx0XHRpZiAoayBpbiByZXQubm92ZWwpXG5cdFx0XHR7XG5cdFx0XHRcdHJldC5ub3ZlbFtrXSA9IGFueVRvQXJyYXkocmV0Lm5vdmVsW2tdLCB0cnVlKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdGlmICgnbm92ZWxfc3RhdHVzJyBpbiByZXQubm92ZWwpXG5cdFx0e1xuXHRcdFx0cmV0Lm5vdmVsLm5vdmVsX3N0YXR1cyA9IGVudlZhbChyZXQubm92ZWwubm92ZWxfc3RhdHVzKTtcblxuXHRcdFx0aWYgKHR5cGVvZiByZXQubm92ZWwubm92ZWxfc3RhdHVzID09PSAnc3RyaW5nJyAmJiAvXjB4W1xcZGEtZl0rJC8udGVzdChyZXQubm92ZWwubm92ZWxfc3RhdHVzKSlcblx0XHRcdHtcblx0XHRcdFx0cmV0Lm5vdmVsLm5vdmVsX3N0YXR1cyA9IE51bWJlcihyZXQubm92ZWwubm92ZWxfc3RhdHVzKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRpZiAoJ2NvbnRyaWJ1dGUnIGluIHJldClcblx0e1xuXHRcdHJldC5jb250cmlidXRlID0gYW55VG9BcnJheShyZXQuY29udHJpYnV0ZSwgdHJ1ZSk7XG5cdH1cblxuXHRyZXQub3B0aW9ucyA9IHJldC5vcHRpb25zIHx8IHt9O1xuXG5cdGlmICh0eXBlb2YgcmV0Lm9wdGlvbnMudGV4dGxheW91dCA9PT0gJ29iamVjdCcpXG5cdHtcblx0XHRPYmplY3QuZW50cmllcyhyZXQub3B0aW9ucy50ZXh0bGF5b3V0KVxuXHRcdFx0LmZvckVhY2goKFtrLCB2XSkgPT4gcmV0Lm9wdGlvbnMudGV4dGxheW91dFtrXSA9IGVudlZhbCh2KSlcblx0XHQ7XG5cdH1cblxuXHRpZiAodHlwZW9mIHJldC5vcHRpb25zLmRvd25sb2FkT3B0aW9ucyA9PT0gJ29iamVjdCcpXG5cdHtcblx0XHRPYmplY3QuZW50cmllcyhyZXQub3B0aW9ucy5kb3dubG9hZE9wdGlvbnMpXG5cdFx0XHQuZm9yRWFjaCgoW2ssIHZdKSA9PiByZXQub3B0aW9ucy5kb3dubG9hZE9wdGlvbnNba10gPSBlbnZWYWwodikpXG5cdFx0O1xuXHR9XG5cblx0cmV0dXJuIHJldDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE5vdmVsVGl0bGVGcm9tTWV0YShtZXRhOiBJTWRjb25mTWV0YSk6IHN0cmluZ1tdXG57XG5cdGlmIChtZXRhICYmIG1ldGEubm92ZWwpXG5cdHtcblx0XHRsZXQgYXJyID0gW1xuXHRcdFx0XHQndGl0bGUnLFxuXHRcdFx0XHQndGl0bGVfc291cmNlJyxcblx0XHRcdFx0J3RpdGxlX2pwJyxcblx0XHRcdFx0J3RpdGxlX2phJyxcblx0XHRcdFx0J3RpdGxlX3poJyxcblx0XHRcdFx0J3RpdGxlX3R3Jyxcblx0XHRcdFx0J3RpdGxlX2NuJyxcblx0XHRcdF0uY29uY2F0KE9iamVjdC5rZXlzKG1ldGEubm92ZWwpKVxuXHRcdFx0LnJlZHVjZShmdW5jdGlvbiAoYSwga2V5OiBzdHJpbmcpXG5cdFx0XHR7XG5cdFx0XHRcdGlmIChrZXkuaW5kZXhPZigndGl0bGUnKSA9PT0gMClcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGEucHVzaChtZXRhLm5vdmVsW2tleV0pXG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXR1cm4gYVxuXHRcdFx0fSwgW10pXG5cdFx0O1xuXG5cdFx0aWYgKG1ldGEubm92ZWwuc2VyaWVzKVxuXHRcdHtcblx0XHRcdGFyci5wdXNoKG1ldGEubm92ZWwuc2VyaWVzLm5hbWUpO1xuXHRcdFx0YXJyLnB1c2gobWV0YS5ub3ZlbC5zZXJpZXMubmFtZV9zaG9ydCk7XG5cdFx0fVxuXG5cdFx0YXJyID0gYXJyYXlfdW5pcXVlKGFyci5maWx0ZXIodiA9PiB2ICYmICFbXG5cdFx0XHQndW5kZWZpbmVkJyxcblx0XHRcdCfplbfnt6gg44CQ6YCj6LyJ44CRJyxcblx0XHRcdCfpgKPovInkuK0nLFxuXHRcdF0uaW5jbHVkZXModikpKTtcblxuXHRcdHJldHVybiBhcnI7XG5cdH1cblxuXHRyZXR1cm4gW107XG59XG5cbmZ1bmN0aW9uIGFueVRvQXJyYXk8VCA9IHN0cmluZz4oaW5wdXQ6IFQgfCBUW10sIHVuaXF1ZT86IGJvb2xlYW4pOiBUW11cbntcblx0aWYgKHR5cGVvZiBpbnB1dCAhPSAnb2JqZWN0Jylcblx0e1xuXHRcdGlucHV0ID0gW2lucHV0XTtcblx0fVxuXG5cdGlmICh1bmlxdWUpXG5cdHtcblx0XHRpbnB1dCA9IGFycmF5X3VuaXF1ZShpbnB1dCB8fCBbXSk7XG5cdH1cblxuXHQvLyBAdHMtaWdub3JlXG5cdHJldHVybiBpbnB1dDtcbn1cblxuZXhwb3J0IGNvbnN0IHZlcnNpb246IHN0cmluZyA9IHJlcXVpcmUoXCIuL3BhY2thZ2UuanNvblwiKS52ZXJzaW9uO1xuXG5leHBvcnQgY29uc3QgbWRjb25mX3BhcnNlID0gcGFyc2U7XG5cbmV4cG9ydCBkZWZhdWx0IGV4cG9ydHMgYXMgdHlwZW9mIGltcG9ydCgnLi9pbmRleCcpO1xuIl19